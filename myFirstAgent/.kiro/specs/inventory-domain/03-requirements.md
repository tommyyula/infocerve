# 库存领域 - 需求规格

## 1. 功能需求

### 1.1 库存管理功能

#### FR-INV-001 创建库存记录

前置条件：用户已登录且有库存创建权限

功能描述：
- 当用户提交库存创建请求时，系统应验证必填字段（customerId、itemId、qty、uomId、lpId）
- 当验证通过时，系统应自动计算 baseQty = qty x 单位换算系数
- 当验证通过时，系统应自动设置默认值（status=OPEN、mode=WMS、type=GOOD、channel=RECEIVE）
- 当验证通过时，系统应记录原始信息（originalLPId、originalBaseQty、originalCreatedTime）
- 当库存创建成功时，系统应自动创建库存日志（actionType=INSERT）
- 当库存创建成功时，系统应自动创建库存活动记录
- 如果开启双单位模式，系统应验证 qty2 和 uomId2 必填

验收标准：
- AC-001: 提供完整必填字段时，库存创建成功，返回库存ID
- AC-002: 缺少必填字段时，返回参数校验错误
- AC-003: baseQty 自动计算正确
- AC-004: 默认值自动填充正确
- AC-005: 库存日志自动创建
- AC-006: 库存活动自动创建
- AC-007: 双单位模式下缺少 qty2/uomId2 时返回错误

---

#### FR-INV-002 更新库存记录

前置条件：库存记录存在

功能描述：
- 当用户提交库存更新请求时，系统应验证库存记录存在
- 当更新数量时，系统应自动重新计算 baseQty
- 当更新成功时，系统应记录变更日志（actionType=UPDATE）
- 双单位验证规则与创建时一致

验收标准：
- AC-001: 更新存在的库存记录成功
- AC-002: 更新不存在的库存记录返回错误
- AC-003: 更新数量时 baseQty 自动重新计算
- AC-004: 变更日志包含变更前后快照

---

#### FR-INV-003 查询库存列表

前置条件：用户已登录且有库存查询权限

功能描述：
- 系统应支持按 customerId、itemId、lpId、locationId、status、lotNo、titleId、type、sn 等条件查询
- 系统应默认排除 qty <= 0 的记录
- 系统应默认排除 status = ADJUSTOUT 的记录
- 系统应支持分页查询
- 系统应支持包含子LP库存查询（includeInnerLp=true）

验收标准：
- AC-001: 按单个条件查询返回正确结果
- AC-002: 按多个条件组合查询返回正确结果
- AC-003: 默认不返回 qty <= 0 的记录
- AC-004: 默认不返回 ADJUSTOUT 状态的记录
- AC-005: 分页参数正确生效
- AC-006: includeInnerLp=true 时返回子LP库存

---

#### FR-INV-004 库存移动

前置条件：源库存存在且数量充足

功能描述：
- 系统应支持 LP 间移动、库位间移动、状态变更、货权变更、货物类型变更
- 当移动时，系统应验证源库存存在且数量充足
- 当移动时，系统应验证目标 LP 状态非 SHIPPED 且非 HLP 类型
- 当移动成功时，系统应扣减源库存数量
- 当移动成功时，系统应创建新库存记录（目标位置）
- 当移动成功时，系统应记录库存日志和活动
- 当移动到拣货位时，LP 应自动关联到库位的 HLP
- 系统应支持整LP移动（isEntireLPMove=true）
- 系统应支持部分数量移动
- 系统应支持双单位移动

验收标准：
- AC-001: LP间移动成功，源库存扣减，目标库存创建
- AC-002: 库位间移动成功
- AC-003: 状态变更移动成功
- AC-004: 源库存不存在时返回错误
- AC-005: 源库存数量不足时返回错误
- AC-006: 目标LP为SHIPPED状态时返回错误
- AC-007: 目标LP为HLP类型时返回错误
- AC-008: 移动到拣货位时自动关联HLP
- AC-009: 整LP移动正确处理
- AC-010: 库存日志和活动正确记录

---

#### FR-INV-005 更新库存状态

前置条件：库存记录存在

功能描述：
- 系统应支持按条件批量更新状态
- 系统应禁止直接更新为 ADJUSTOUT 状态
- 系统应默认排除 qty <= 0 和 ADJUSTOUT 状态的记录
- 当状态更新为 OPEN 时，系统应发送库存变更事件

验收标准：
- AC-001: 批量更新状态成功
- AC-002: 尝试更新为 ADJUSTOUT 时返回错误
- AC-003: 不影响 qty <= 0 的记录
- AC-004: 不影响 ADJUSTOUT 状态的记录
- AC-005: 更新为 OPEN 时发送变更事件

---

#### FR-INV-006 库存差异标记管理

前置条件：库存记录存在

功能描述：
- 系统应支持设置差异标记（DISCREPANCY / WARNING）
- 系统应支持按条件批量释放差异标记
- 当释放单条库存差异时，如果该商品无其他 DISCREPANCY 记录，系统应同时释放 WARNING 记录

验收标准：
- AC-001: 设置差异标记成功
- AC-002: 批量释放差异标记成功
- AC-003: 释放单条差异时联动释放 WARNING

---

#### FR-INV-007 库存单位转换

前置条件：源库存存在且具有相同的 uomId

功能描述：
- 系统应支持将库存从一个计量单位转换为另一个
- 系统应验证所有源库存具有相同的 uomId
- 转换后的数量 = 总数量 x 原单位基础数量 / 新单位基础数量
- 系统应验证转换结果为整数

验收标准：
- AC-001: 单位转换成功，数量正确计算
- AC-002: 源库存 uomId 不一致时返回错误
- AC-003: 转换结果非整数时返回错误

---

#### FR-INV-008 库存统计查询

前置条件：用户已登录且有查询权限

功能描述：
- 系统应支持按条件统计库存总数量
- 系统应支持按条件统计不同 LP 数量
- 系统应支持按 LP 统计商品种类数量

验收标准：
- AC-001: 库存总数量统计正确
- AC-002: LP数量统计正确
- AC-003: 按LP统计商品种类数量正确

---

#### FR-INV-009 库存批量导入

前置条件：用户已登录且有导入权限

功能描述：
- 系统应支持文件上传（CSV/Excel格式）
- 系统应提供模板下载功能
- 系统应支持数据预览和字段映射
- 系统应验证所有记录属于同一客户
- 系统应验证所有 lpId 存在
- 系统应验证所有 locationId 存在
- 导入应通过创建调整单（ADD_INVENTORY）实现
- 调整单应自动审批

验收标准：
- AC-001: CSV文件上传解析成功
- AC-002: Excel文件上传解析成功
- AC-003: 模板下载成功
- AC-004: 数据预览正确显示
- AC-005: 字段映射正确生效
- AC-006: 不同客户记录时返回错误
- AC-007: lpId不存在时返回错误
- AC-008: locationId不存在时返回错误
- AC-009: 导入成功创建调整单并自动审批

---

#### FR-INV-010 库存数据导出

前置条件：用户已登录且有导出权限

功能描述：
- 系统应支持按条件筛选导出
- 系统应支持 CSV 和 Excel 格式
- 导出字段应包含基础字段、位置字段、属性字段、动态字段
- 系统应支持大数据量分批导出
- 系统应支持异步导出

验收标准：
- AC-001: CSV格式导出成功
- AC-002: Excel格式导出成功
- AC-003: 筛选条件正确生效
- AC-004: 导出字段完整
- AC-005: 大数据量异步导出成功

---

### 1.2 LP管理功能

#### FR-LP-001 创建LP

前置条件：用户已登录且有LP创建权限

功能描述：
- 系统应支持创建多种类型的 LP（ILP、HLP、CLP、SLP、TLP、RLP）
- LP ID 格式应为 {TYPE}-{PREFIX}{SEQUENCE}
- 默认状态应为 NEW
- 系统应支持指定前缀（lpPrefix）
- 系统应支持批量创建

验收标准：
- AC-001: 创建各类型LP成功
- AC-002: LP ID格式正确
- AC-003: 默认状态为NEW
- AC-004: 指定前缀正确生效
- AC-005: 批量创建成功

---

#### FR-LP-002 更新LP

前置条件：LP记录存在

功能描述：
- 系统应支持更新 LP 的所有可变字段
- 系统应支持指定需要置空的字段（nullifyFields）
- 系统应支持批量更新状态
- 系统应支持批量更新父LP关系

验收标准：
- AC-001: 更新LP字段成功
- AC-002: nullifyFields正确置空指定字段
- AC-003: 批量更新状态成功
- AC-004: 批量更新父LP关系成功

---

#### FR-LP-003 查询LP

前置条件：用户已登录且有查询权限

功能描述：
- 系统应支持按 LP ID、库位ID、状态、类型、父LP ID、外部LPN 等条件查询
- 系统应支持分页查询
- 系统应支持查询包含子LP（getLpIncludeInnerLp）
- 系统应支持查询包含父LP（getLpIncludeParentLp）
- 系统应支持构建最外层LP列表（buildOuterLPs）

验收标准：
- AC-001: 按条件查询返回正确结果
- AC-002: 分页查询正确
- AC-003: 包含子LP查询正确
- AC-004: 包含父LP查询正确
- AC-005: 构建最外层LP列表正确

---

#### FR-LP-004 删除LP

前置条件：LP记录存在

功能描述：
- 删除 LP 时应标记为 ON_HOLD 状态（软删除）
- 如果 LP 中有库存，系统应创建调整单将库存数量调整为 0
- 调整单应自动审批

验收标准：
- AC-001: 删除空LP成功，状态变为ON_HOLD
- AC-002: 删除有库存的LP时创建调整单
- AC-003: 调整单自动审批成功

---

#### FR-LP-005 LP整体移动

前置条件：LP记录存在

功能描述：
- 系统应更新 LP 的 parentId 和 locationId
- 系统应同步更新 LP 内所有库存的 locationId

验收标准：
- AC-001: LP位置更新成功
- AC-002: LP内库存位置同步更新

---

### 1.3 调整管理功能

#### FR-ADJ-001 创建调整单

前置条件：用户已登录且有调整单创建权限

功能描述：
- 系统应支持创建包含必要信息的调整单（customerId、reason、note、lines）
- 调整单ID格式应为 ADJ-{SEQUENCE}
- 初始状态应为 NEW
- 系统应支持立即审批（approveNow=true）
- 系统应支持批量创建

验收标准：
- AC-001: 创建调整单成功
- AC-002: 调整单ID格式正确
- AC-003: 初始状态为NEW
- AC-004: approveNow=true时立即审批
- AC-005: 批量创建成功

---

#### FR-ADJ-002 审批调整单

前置条件：调整单存在且状态为NEW

功能描述：
- 系统应验证调整单状态为 NEW
- 系统应按调整类型执行相应操作
- 审批后状态应更新为 APPROVED
- 系统应记录审批时间和审批人
- 系统应创建调整历史记录
- 系统应发送调整审批事件
- 系统应支持批量审批
- 系统应防止重复提交

验收标准：
- AC-001: ADD_INVENTORY类型创建库存成功
- AC-002: ADJUST_QTY增加时创建库存成功
- AC-003: ADJUST_QTY减少时库存移动到ADJUSTOUT
- AC-004: ADJUST_STATUS/TITLE/LP/LOCATION正确执行
- AC-005: 状态更新为APPROVED
- AC-006: 调整历史记录创建
- AC-007: 批量审批成功
- AC-008: 重复提交被拦截

---

#### FR-ADJ-003 查询调整单

前置条件：用户已登录且有查询权限

功能描述：
- 系统应支持按条件查询调整单
- 系统应支持查询调整单详情（包含调整行）
- 系统应支持查询调整行
- 系统应支持分页查询

验收标准：
- AC-001: 按条件查询调整单成功
- AC-002: 查询调整单详情包含调整行
- AC-003: 查询调整行成功
- AC-004: 分页查询正确

---

#### FR-ADJ-004 管理调整行

前置条件：调整单存在且状态为NEW

功能描述：
- 系统应支持单独创建调整行
- 系统应支持批量创建调整行
- 系统应支持更新调整行
- 系统应支持删除调整行

验收标准：
- AC-001: 创建调整行成功
- AC-002: 批量创建调整行成功
- AC-003: 更新调整行成功
- AC-004: 删除调整行成功

---

### 1.4 库存锁定功能

#### FR-LOCK-001 创建库存锁定

前置条件：订单存在

功能描述：
- 系统应支持按订单行锁定库存
- 锁定记录应包含 orderId、orderItemLineId、itemId、qty、baseQty、availableBaseQty
- 初始状态应为 ACTIVE
- 系统应支持双单位锁定

验收标准：
- AC-001: 创建库存锁定成功
- AC-002: 锁定记录字段完整
- AC-003: 初始状态为ACTIVE
- AC-004: 双单位锁定正确

---

#### FR-LOCK-002 查询库存锁定

前置条件：用户已登录且有查询权限

功能描述：
- 系统应支持按订单ID、订单行ID、商品ID、客户ID、状态等条件查询
- 系统应支持分页查询

验收标准：
- AC-001: 按条件查询成功
- AC-002: 分页查询正确

---

#### FR-LOCK-003 释放库存锁定

前置条件：锁定记录存在

功能描述：
- 系统应支持将锁定状态更新为 INACTIVE
- 系统应支持批量释放

验收标准：
- AC-001: 释放锁定成功，状态变为INACTIVE
- AC-002: 批量释放成功

---

#### FR-LOCK-004 库存锁定数据导出

前置条件：用户已登录且有导出权限

功能描述：
- 系统应支持按条件筛选导出
- 系统应支持 CSV 和 Excel 格式
- 系统应支持大数据量异步导出

验收标准：
- AC-001: 导出成功
- AC-002: 筛选条件正确生效
- AC-003: 异步导出成功

---

### 1.5 日志审计功能

#### FR-LOG-001 库存日志记录

前置条件：库存数据发生变更

功能描述：
- 系统应在创建、更新、移动库存时自动记录日志
- 日志应包含变更前后的完整快照（JSON格式）
- 系统应支持按库存ID、商品ID、操作类型等条件查询

验收标准：
- AC-001: 创建库存时自动记录日志
- AC-002: 更新库存时自动记录日志
- AC-003: 移动库存时自动记录日志
- AC-004: 日志包含完整快照
- AC-005: 按条件查询日志成功

---

#### FR-LOG-002 库存活动记录

前置条件：库存操作发生

功能描述：
- 系统应在创建库存、库存移动时自动记录活动
- 活动记录应包含完整的流转信息
- 系统应支持 API 手动创建活动记录

验收标准：
- AC-001: 创建库存时自动记录活动
- AC-002: 库存移动时自动记录活动
- AC-003: 活动记录包含完整流转信息
- AC-004: API手动创建活动成功

---

### 1.6 汇总统计功能

#### FR-SUM-001 料箱库存汇总

前置条件：料箱存在

功能描述：
- 系统应自动汇总料箱内的库存信息
- 汇总信息应包含商品种类数、总库存数量、单品最小/最大数量、最近上架时间、是否有差异标记

验收标准：
- AC-001: 汇总信息正确
- AC-002: 各统计字段计算正确

---

### 1.7 配置管理功能

#### FR-CFG-001 动态属性映射配置

前置条件：用户已登录且有配置权限

功能描述：
- 系统应支持将库存表的动态字段映射为业务名称
- 系统应支持 INVENTORY 和 LOCATION 两种映射类型
- 不同租户应可以有不同的映射配置

验收标准：
- AC-001: 创建映射配置成功
- AC-002: 查询映射配置成功
- AC-003: 更新映射配置成功
- AC-004: 删除映射配置成功
- AC-005: 不同租户配置隔离

---

#### FR-CFG-002 自定义字段显示配置

前置条件：用户已登录且有配置权限

功能描述：
- 系统应支持按客户ID和模式配置显示字段列表
- 前端应根据配置动态渲染表格列

验收标准：
- AC-001: 创建显示配置成功
- AC-002: 查询显示配置成功
- AC-003: 更新显示配置成功
- AC-004: 删除显示配置成功

---

#### FR-CFG-003 序列号管理

前置条件：无

功能描述：
- 系统应支持按类型生成序列号
- 系统应支持批量获取序号
- 序号应单调递增，不重复
- 系统应保证并发安全

验收标准：
- AC-001: 获取序列号成功
- AC-002: 批量获取序列号成功
- AC-003: 序列号单调递增
- AC-004: 并发获取不重复

---

## 2. 非功能需求

### 2.1 性能需求

NFR-PERF-001 查询响应时间
- 库存查询响应时间应小于 500ms
- 库存移动操作响应时间应小于 1s

NFR-PERF-002 数据容量
- 系统应支持单表百万级数据量

NFR-PERF-003 并发处理
- 系统应支持 100 TPS 的并发请求

---

### 2.2 可用性需求

NFR-AVAIL-001 系统可用性
- 系统可用性应大于 99.9%

NFR-AVAIL-002 优雅停机
- 系统应支持优雅停机，不丢失正在处理的请求

NFR-AVAIL-003 配置热更新
- 系统应支持配置热更新，无需重启

---

### 2.3 安全需求

NFR-SEC-001 认证授权
- 所有接口应需要认证
- 应支持基于角色的权限控制

NFR-SEC-002 多租户隔离
- 系统应支持多租户数据隔离
- 租户间数据应完全隔离

NFR-SEC-003 审计日志
- 敏感操作应需要审计日志

---

### 2.4 可维护性需求

NFR-MAINT-001 测试覆盖率
- 领域层单元测试覆盖率应大于 90%
- 应用层单元测试覆盖率应大于 80%

NFR-MAINT-002 API文档
- 应提供完整的 API 文档

NFR-MAINT-003 错误码规范
- 应使用统一的错误码规范

---

## 3. 约束条件

### 3.1 技术约束

- 使用 Java 17+ 开发
- 使用 Spring Boot 3.x 框架
- 使用 MyBatis-Plus 持久化框架
- 使用 MySQL 8.0+ 数据库
- 使用 Gradle 构建工具

### 3.2 架构约束

- 遵循 DDD 分层架构（interfaces、application、domain、infrastructure）
- 一个事务只修改一个聚合
- 聚合间通过领域事件通信

### 3.3 兼容性约束

- API 接口应与原 inventory-service-backend 兼容
- 数据库表结构应支持数据迁移

---

## 参考文档

- .kiro/specs/inventory-domain/01-story.md（用户故事）
- .kiro/specs/inventory-domain/02-domain-analysis.md（领域分析）

