# 库存领域用户故事

## 项目背景

当前 `inventory-service-backend` 是一个独立的库存微服务，采用 DDD（领域驱动设计）架构。为了简化系统架构、降低运维成本，需要将库存服务重构并整合到 `wms-lite-backend` 的 `wms-app` 模块中。

### 重构目标

1. 简化库存服务，去除冗余功能
2. 保持 DDD 分层架构设计
3. 精简数据模型，保留核心字段
4. 支持多租户隔离
5. 提供清晰的 API 接口

### 技术栈

- Java 17+
- Spring Boot 3.x
- MyBatis-Plus
- MySQL 8.0+
- Gradle

---

## Epic 1：库存管理

### US-INV-001：创建库存记录

作为 仓库操作员
我希望 能够创建新的库存记录
以便 记录入库的货物信息

验收标准：
1. 系统应支持创建包含必填信息的库存记录（customerId、itemId、qty、uomId、lpId）
2. 系统应自动计算基础数量（baseQty = qty x 单位换算系数）
3. 系统应自动设置默认值（status=OPEN、mode=WMS、type=GOOD、channel=RECEIVE）
4. 系统应记录原始信息用于追溯（originalLPId、originalBaseQty、originalCreatedTime）
5. 系统应自动创建库存日志（InventoryLog）
6. 系统应自动创建库存活动记录（InventoryActivity）
7. 如果开启双单位，必须提供有效的 qty2 和 uomId2

---

### US-INV-002：更新库存记录

作为 仓库操作员
我希望 能够更新现有库存记录的信息
以便 修正或补充库存数据

验收标准：
1. 系统应支持更新库存的可变字段（qty、uomId、lotNo、expirationDate、mfgDate、sn、动态属性）
2. 更新数量时应自动重新计算 baseQty
3. 系统应记录更新前后的变更日志
4. 双单位验证规则与创建时一致

---

### US-INV-003：查询库存列表

作为 仓库管理员
我希望 能够按多种条件查询库存列表
以便 了解当前库存状况

验收标准：
1. 系统应支持多条件查询（customerId、itemId、lpId、locationId、status、lotNo、titleId、type、sn）
2. 默认排除 qty <= 0 的记录
3. 默认排除 status = ADJUSTOUT 的记录
4. 支持分页查询
5. 支持包含子LP库存查询（includeInnerLp）

---

### US-INV-004：库存移动

作为 仓库操作员
我希望 能够将库存从一个位置移动到另一个位置
以便 完成上架、拣货、补货等操作

验收标准：
1. 系统应支持多种移动场景（LP间移动、库位间移动、状态变更、货权变更、货物类型变更）
2. 移动时应验证源库存存在且数量充足
3. 移动时应验证目标LP状态有效（非SHIPPED）且非HLP类型
4. 移动操作应扣减源库存数量、创建新库存记录、记录日志和活动
5. 支持整LP移动（isEntireLPMove）
6. 支持部分数量移动
7. 支持双单位移动
8. 移动到拣货位时，LP应自动关联到库位的HLP

---

### US-INV-005：更新库存状态

作为 系统
我希望 能够批量更新库存状态
以便 支持业务流程中的状态流转

验收标准：
1. 系统应支持按条件批量更新状态
2. 不允许直接更新为 ADJUSTOUT 状态（需通过调整单）
3. 默认排除 qty <= 0 和 ADJUSTOUT 状态的记录
4. 状态更新为 OPEN 时应发送库存变更事件

---

### US-INV-006：库存差异标记管理

作为 仓库管理员
我希望 能够标记和释放库存差异
以便 追踪和处理盘点差异

验收标准：
1. 系统应支持设置差异标记（DISCREPANCY / WARNING）
2. 系统应支持按条件批量释放差异标记
3. 释放单条库存差异时，如果该商品无其他 DISCREPANCY 记录，应同时释放 WARNING 记录

---

### US-INV-007：库存单位转换

作为 仓库操作员
我希望 能够转换库存的计量单位
以便 适应不同的业务场景

验收标准：
1. 系统应支持将库存从一个计量单位转换为另一个
2. 转换时应验证所有源库存具有相同的 uomId
3. 转换后的数量 = 总数量 x 原单位基础数量 / 新单位基础数量
4. 转换结果必须为整数，否则报错

---

### US-INV-008：库存统计查询

作为 仓库管理员
我希望 能够查询库存统计数据
以便 了解库存概况

验收标准：
1. 支持按条件统计库存总数量
2. 支持按条件统计不同 LP 数量
3. 支持按 LP 统计商品种类数量

---

### US-INV-009：库存批量导入

作为 仓库管理员
我希望 能够通过界面批量导入库存数据
以便 快速初始化或调整库存

验收标准：
1. 系统应支持文件上传（拖拽或点击浏览，支持 CSV/Excel 格式）
2. 系统应提供模板下载功能
3. 系统应支持数据预览和字段映射
4. 系统应验证数据（同一客户、lpId存在、locationId存在、必填字段）
5. 导入通过创建调整单（ADD_INVENTORY）实现
6. 调整单自动审批

---

### US-INV-010：库存数据导出

作为 仓库管理员
我希望 能够导出库存数据
以便 进行数据分析、备份或与外部系统对接

验收标准：
1. 系统应支持按条件筛选导出
2. 系统应支持 CSV 和 Excel 格式
3. 导出字段应包含基础字段、位置字段、属性字段、动态字段
4. 支持大数据量分批导出
5. 支持异步导出（大数据量时）

---

## Epic 2：LP（容器）管理

### US-LP-001：创建 LP

作为 仓库操作员
我希望 能够创建新的 LP（容器）
以便 用于存放和管理库存

验收标准：
1. 系统应支持创建多种类型的 LP（ILP、HLP、CLP、SLP、TLP、RLP）
2. LP ID 格式：{TYPE}-{PREFIX}{SEQUENCE}
3. 默认状态为 NEW
4. 支持指定前缀（lpPrefix）
5. 支持批量创建

---

### US-LP-002：更新 LP

作为 仓库操作员
我希望 能够更新 LP 信息
以便 维护 LP 的准确状态

验收标准：
1. 系统应支持更新 LP 的所有可变字段
2. 支持指定需要置空的字段（nullifyFields）
3. 支持批量更新状态
4. 支持批量更新父LP关系

---

### US-LP-003：查询 LP

作为 仓库管理员
我希望 能够按多种条件查询 LP
以便 了解容器使用情况

验收标准：
1. 系统应支持多条件查询（LP ID、库位ID、状态、类型、父LP ID、外部LPN）
2. 支持分页查询
3. 支持查询包含子LP
4. 支持查询包含父LP
5. 支持构建最外层LP列表

---

### US-LP-004：删除 LP

作为 仓库管理员
我希望 能够删除不再使用的 LP
以便 清理无效数据

验收标准：
1. 删除 LP 时不物理删除，而是标记为 ON_HOLD 状态
2. 如果 LP 中有库存，应创建调整单将库存数量调整为 0
3. 调整单自动审批

---

### US-LP-005：LP 整体移动

作为 仓库操作员
我希望 能够将 LP 整体移动到新位置
以便 完成托盘移动操作

验收标准：
1. 系统应更新 LP 的 parentId 和 locationId
2. 系统应同步更新 LP 内所有库存的 locationId

---

## Epic 3：库存调整管理

### US-ADJ-001：创建调整单

作为 仓库管理员
我希望 能够创建库存调整单
以便 记录和执行库存调整操作

验收标准：
1. 系统应支持创建包含必要信息的调整单（customerId、reason、note、lines）
2. 调整单ID格式：ADJ-{SEQUENCE}
3. 初始状态为 NEW
4. 支持立即审批（approveNow = true）
5. 支持批量创建

---

### US-ADJ-002：审批调整单

作为 仓库管理员
我希望 能够审批库存调整单
以便 执行库存调整操作

验收标准：
1. 系统应验证调整单状态为 NEW
2. 系统应按调整类型执行相应操作（ADD_INVENTORY、ADJUST_QTY、ADJUST_STATUS 等）
3. 审批后更新状态为 APPROVED
4. 记录审批时间和审批人
5. 创建调整历史记录
6. 发送调整审批事件
7. 支持批量审批
8. 防止重复提交

---

### US-ADJ-003：查询调整单

作为 仓库管理员
我希望 能够查询调整单及其明细
以便 了解调整历史

验收标准：
1. 系统应支持按条件查询调整单
2. 系统应支持查询调整单详情（包含调整行）
3. 系统应支持查询调整行
4. 支持分页查询

---

### US-ADJ-004：管理调整行

作为 仓库管理员
我希望 能够单独管理调整行
以便 灵活调整调整单内容

验收标准：
1. 系统应支持单独创建调整行
2. 系统应支持批量创建调整行
3. 系统应支持更新调整行
4. 系统应支持删除调整行

---

## Epic 4：库存锁定管理

### US-LOCK-001：创建库存锁定

作为 订单系统
我希望 能够锁定库存
以便 为订单预留库存

验收标准：
1. 系统应支持按订单行锁定库存
2. 锁定记录应包含必要信息（orderId、orderItemLineId、itemId、qty、baseQty、availableBaseQty）
3. 初始状态为 ACTIVE
4. 支持双单位锁定

---

### US-LOCK-002：查询库存锁定

作为 订单系统
我希望 能够查询库存锁定记录
以便 了解库存预留情况

验收标准：
1. 系统应支持多条件查询（订单ID、订单行ID、商品ID、客户ID、状态）
2. 支持分页查询

---

### US-LOCK-003：释放库存锁定

作为 订单系统
我希望 能够释放库存锁定
以便 取消订单时释放预留库存

验收标准：
1. 系统应支持将锁定状态更新为 INACTIVE
2. 支持批量释放

---

### US-LOCK-004：库存锁定数据导出

作为 仓库管理员
我希望 能够导出库存锁定数据
以便 分析订单库存预留情况

验收标准：
1. 系统应支持按条件筛选导出
2. 系统应支持 CSV 和 Excel 格式
3. 导出字段应包含基础字段、数量字段、属性字段、时间字段、动态字段
4. 支持大数据量分批导出
5. 支持异步导出

---

## Epic 5：库存活动与日志

### US-LOG-001：库存日志记录

作为 仓库管理员
我希望 系统能够自动记录库存的所有变更
以便 追溯库存数据的变更历史

验收标准：
1. 系统应在创建、更新、移动库存时自动记录日志
2. 日志应包含变更前后的完整快照（JSON格式）
3. 支持按库存ID、商品ID、操作类型等条件查询

---

### US-LOG-002：库存活动记录

作为 仓库管理员
我希望 系统能够自动记录库存的业务操作历史
以便 追踪库存在仓库中的完整流转过程

验收标准：
1. 系统应在创建库存、库存移动时自动记录活动
2. 活动记录应包含完整的流转信息（fromLPId、toLPId、fromLocationId、toLocationId、activityType、taskId）
3. 支持 API 手动创建活动记录

---

## Epic 6：汇总与统计

### US-SUM-001：料箱库存汇总

作为 仓库管理员
我希望 能够查询料箱库存汇总信息
以便 快速了解料箱内容

验收标准：
1. 系统应自动汇总料箱内的库存信息
2. 汇总信息应包含商品种类数、总库存数量、单品最小/最大数量、最近上架时间、是否有差异标记

---

## Epic 7：配置管理

### US-CFG-001：动态属性映射配置

作为 系统管理员
我希望 能够配置动态属性的业务名称映射
以便 将通用字段映射为业务可读名称

验收标准：
1. 系统应支持将库存表的动态字段映射为业务名称
2. 支持 INVENTORY 和 LOCATION 两种映射类型
3. 不同租户可以有不同的映射配置
4. 写入数据时根据业务名称查找对应的原始字段进行存储
5. 读取数据时根据原始字段查找业务名称进行展示

---

### US-CFG-002：自定义字段显示配置

作为 系统管理员
我希望 能够配置不同客户/模式下显示的字段
以便 实现界面个性化

验收标准：
1. 系统应支持按客户ID和模式配置显示字段列表
2. 前端根据配置动态渲染表格列
3. 支持 CRUD 操作

---

### US-CFG-003：序列号管理

作为 系统
我希望 能够生成唯一的业务序列号
以便 为调整单、LP等生成唯一ID

验收标准：
1. 系统应支持按类型生成序列号（ADJUSTMENT、LP等）
2. 序列号格式可配置
3. 支持批量获取序号，减少数据库访问
4. 序号应单调递增，不重复

---

## 参考文档

- docs/Inventory_Service_User_Stories.md（原始用户故事文档）
- inventory-service-backend 源代码

