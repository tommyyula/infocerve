# 库存导入 FSD

## 1. 功能概述

### 1.1 功能目标

提供批量导入库存数据的功能，支持文件上传、模板下载、数据预览和字段映射，通过创建调整单实现库存导入。

### 1.2 关联用户故事

- US-INV-009：库存批量导入

### 1.3 关联需求项

- FR-INV-009：库存批量导入

---

## 2. 用户场景

### 场景 1：下载导入模板

角色：仓库管理员
前置条件：用户已登录，有导入权限
操作流程：
1. 用户进入库存导入页面
2. 用户点击"下载模板"按钮
3. 浏览器下载 Excel 模板文件

预期结果：成功下载包含标准字段的模板文件

### 场景 2：上传导入文件

角色：仓库管理员
前置条件：已准备好导入数据文件
操作流程：
1. 用户拖拽文件到上传区域，或点击上传区域选择文件
2. 系统解析文件内容
3. 系统在数据预览区显示解析结果
4. 系统自动匹配字段映射

预期结果：文件解析成功，数据预览正确显示

### 场景 3：调整字段映射

角色：仓库管理员
前置条件：已上传文件并显示预览
操作流程：
1. 用户查看字段映射区域
2. 用户调整源字段与目标字段的映射关系
3. 系统根据新映射更新数据预览

预期结果：字段映射正确调整

### 场景 4：提交导入

角色：仓库管理员
前置条件：数据预览无误，字段映射正确
操作流程：
1. 用户点击"提交导入"按钮
2. 系统验证数据（同一客户、LP存在、库位存在）
3. 系统创建调整单（ADD_INVENTORY 类型）
4. 系统自动审批调整单
5. 显示导入成功提示

预期结果：库存数据导入成功

---

## 3. 界面说明

### 3.1 页面布局

对应 Demo：05-demo/index.html#inventory-import

页面分为四个区域：
- 返回按钮：页面顶部，返回库存列表
- 上传区域：文件上传和模板下载
- 数据预览：显示解析后的数据
- 字段映射：配置字段对应关系

### 3.2 页面区域

区域 A：返回导航
- 位置：页面顶部
- 功能：返回库存列表页面
- 包含元素：返回按钮

区域 B：上传卡片
- 位置：返回按钮下方
- 功能：文件上传和模板下载
- 包含元素：
  - 标题：批量导入
  - 下载模板按钮（右上角）
  - 上传区域（拖拽或点击）
  - 支持格式提示

区域 C：数据预览卡片
- 位置：上传卡片下方
- 功能：显示解析后的数据
- 包含元素：
  - 标题：数据预览
  - 数据表格（#、客户、商品、数量、单位、LP、库位）
  - 空状态提示

区域 D：字段映射卡片
- 位置：数据预览下方
- 功能：配置字段映射
- 包含元素：
  - 标题：字段映射
  - 映射表单（每行4个字段）
  - 取消按钮、提交导入按钮

---

## 4. 交互逻辑

### 4.1 页面加载

触发时机：页面首次加载
处理逻辑：
1. 显示空的上传区域
2. 显示空的数据预览（暂无上传数据）
3. 显示默认字段映射配置

### 4.2 下载模板

触发时机：用户点击"下载模板"按钮
处理逻辑：
1. 调用 API：GET /api/inventory/import/template
2. 触发文件下载
3. 文件名：inventory_import_template.xlsx

### 4.3 上传文件

触发时机：用户拖拽文件或点击选择文件
处理逻辑：
1. 验证文件格式（CSV/Excel）
2. 验证文件大小（不超过 10MB）
3. 解析文件内容
4. 显示解析进度
5. 解析成功后更新数据预览
6. 自动匹配字段映射
7. 解析失败显示错误提示

### 4.4 调整字段映射

触发时机：用户修改映射下拉框
处理逻辑：
1. 更新映射配置
2. 根据新映射重新渲染数据预览

### 4.5 提交导入

触发时机：用户点击"提交导入"按钮
处理逻辑：
1. 前端校验：数据不为空
2. 收集映射后的数据
3. 调用 API：POST /api/inventory/upload
4. 显示 loading 状态
5. 成功后显示"导入成功"提示
6. 成功后跳转回库存列表页面
7. 失败后显示错误详情

### 4.6 取消导入

触发时机：用户点击"取消"按钮
处理逻辑：
1. 跳转回库存列表页面

---

## 5. 数据字段

### 5.1 导入字段

字段名：customerId
- 字段标识：customerId
- 数据类型：string
- 是否必填：是
- 校验规则：不能为空，必须存在

字段名：itemId
- 字段标识：itemId
- 数据类型：string
- 是否必填：是
- 校验规则：不能为空，必须存在

字段名：qty
- 字段标识：qty
- 数据类型：number
- 是否必填：是
- 校验规则：必须大于 0

字段名：uomId
- 字段标识：uomId
- 数据类型：string
- 是否必填：是
- 校验规则：不能为空，必须存在

字段名：lpId
- 字段标识：lpId
- 数据类型：string
- 是否必填：是
- 校验规则：不能为空，LP 必须存在

字段名：locationId
- 字段标识：locationId
- 数据类型：string
- 是否必填：是
- 校验规则：不能为空，库位必须存在

字段名：titleId
- 字段标识：titleId
- 数据类型：string
- 是否必填：否

字段名：lotNo
- 字段标识：lotNo
- 数据类型：string
- 是否必填：否

### 5.2 预览表格字段

字段名：#
- 字段标识：rowIndex
- 数据类型：number
- 显示格式：行号

字段名：客户
- 字段标识：customerId
- 数据类型：string

字段名：商品
- 字段标识：itemId
- 数据类型：string

字段名：数量
- 字段标识：qty
- 数据类型：number

字段名：单位
- 字段标识：uomId
- 数据类型：string

字段名：LP
- 字段标识：lpId
- 数据类型：string

字段名：库位
- 字段标识：locationId
- 数据类型：string

---

## 6. 业务规则

### 6.1 数据验证规则

BR-IMP-001：同一客户验证
- 触发条件：提交导入
- 处理逻辑：所有记录必须属于同一个 customerId
- 影响范围：整个导入批次

BR-IMP-002：LP 存在验证
- 触发条件：提交导入
- 处理逻辑：所有 lpId 必须在系统中存在
- 影响范围：每条记录

BR-IMP-003：库位存在验证
- 触发条件：提交导入
- 处理逻辑：所有 locationId 必须在系统中存在
- 影响范围：每条记录

### 6.2 导入规则

BR-IMP-005：通过调整单导入
- 触发条件：提交导入
- 处理逻辑：创建 ADD_INVENTORY 类型的调整单
- 影响范围：系统行为

BR-IMP-006：自动审批
- 触发条件：调整单创建成功
- 处理逻辑：调整单自动审批
- 影响范围：系统行为

---

## 7. 异常处理

### 7.1 文件格式错误

错误场景：上传非 CSV/Excel 文件
错误提示：文件格式不支持，请上传 CSV 或 Excel 文件
处理方式：显示错误提示，不进行解析

### 7.2 文件过大

错误场景：文件超过 10MB
错误提示：文件过大，请控制在 10MB 以内
处理方式：显示错误提示，不进行解析

### 7.3 解析失败

错误场景：文件内容无法解析
错误提示：文件解析失败，请检查文件格式
处理方式：显示错误提示，清空预览区域

### 7.4 数据验证失败

错误场景：数据不符合业务规则
错误提示：
- 不同客户：所有记录必须属于同一客户
- LP不存在：第 X 行 LP [lpId] 不存在
- 库位不存在：第 X 行库位 [locationId] 不存在
处理方式：显示详细错误信息，标记错误行

### 7.5 导入失败

错误场景：API 返回错误
错误提示：导入失败：{错误信息}
处理方式：显示错误提示，保持当前页面状态

---

## 8. 依赖说明

### 8.1 API 接口

接口：下载导入模板
- 路径：GET /api/inventory/import/template
- 详细设计：07-design.md#2.1
- 用途：下载标准导入模板
- 调用时机：点击下载模板按钮

接口：批量导入
- 路径：POST /api/inventory/upload
- 详细设计：07-design.md#2.1
- 用途：提交导入数据
- 调用时机：点击提交导入按钮
- 成功后处理：显示成功提示，跳转列表页
- 失败后处理：显示错误详情

### 8.2 组件依赖

- FileUpload：文件上传组件
- DataTable：数据表格组件
- Select：下拉选择组件

### 8.3 权限要求

- inventory:import：导入库存

---

## 9. 国际化（i18n）

### 9.1 静态文案

页面标题：
- key：inventory.import.title
- 中文：批量导入
- 英文：Batch Import

按钮文案：
- key：inventory.import.downloadTemplate
- 中文：下载模板
- 英文：Download Template

- key：inventory.import.submit
- 中文：提交导入
- 英文：Submit Import

- key：common.cancel
- 中文：取消
- 英文：Cancel

上传区域：
- key：inventory.import.uploadHint
- 中文：拖拽文件或点击上传
- 英文：Drag file or click to upload

- key：inventory.import.formatHint
- 中文：支持 CSV / Excel，导入将自动创建调整单并审批
- 英文：Support CSV / Excel, import will create and approve adjustment automatically

### 9.2 错误提示

- key：inventory.import.error.format
- 中文：文件格式不支持，请上传 CSV 或 Excel 文件
- 英文：File format not supported, please upload CSV or Excel file

- key：inventory.import.error.size
- 中文：文件过大，请控制在 10MB 以内
- 英文：File too large, please keep it under 10MB

---

## 10. 数据模型引用

### 10.1 涉及的聚合/实体

聚合根：Inventory
- 详细定义：04-domain-model.md#2.1
- 本模块使用的属性：customerId、itemId、qty、uomId、lpId、locationId、titleId、lotNo

聚合根：Adjustment
- 详细定义：04-domain-model.md#3.1
- 本模块使用的属性：导入通过创建调整单实现

---

## 11. API 接口引用

### 11.1 查询接口

接口：下载导入模板
- 路径：GET /api/inventory/import/template
- 详细设计：07-design.md#2.1
- 用途：获取标准导入模板
- 调用时机：点击下载模板按钮

### 11.2 命令接口

接口：批量导入
- 路径：POST /api/inventory/upload
- 详细设计：07-design.md#2.1
- 用途：提交导入数据
- 调用时机：点击提交导入按钮
- 成功后处理：显示成功提示，跳转列表页
- 失败后处理：显示错误详情

---

## 12. 验收标准引用

### 12.1 关联的验收标准

来源：03-requirements.md

AC-001（FR-INV-009）：CSV文件上传解析成功
- 对应交互：本文档 4.3 上传文件
- 验证方式：上传 CSV 文件，验证解析正确

AC-002（FR-INV-009）：Excel文件上传解析成功
- 对应交互：本文档 4.3 上传文件
- 验证方式：上传 Excel 文件，验证解析正确

AC-003（FR-INV-009）：模板下载成功
- 对应交互：本文档 4.2 下载模板
- 验证方式：点击下载，验证文件下载成功

AC-006（FR-INV-009）：不同客户记录时返回错误
- 对应交互：本文档 4.5 提交导入
- 验证方式：导入包含不同客户的数据，验证返回错误

AC-007（FR-INV-009）：lpId不存在时返回错误
- 对应交互：本文档 4.5 提交导入
- 验证方式：导入不存在的 LP，验证返回错误

AC-009（FR-INV-009）：导入成功创建调整单并自动审批
- 对应交互：本文档 4.5 提交导入
- 验证方式：导入成功后，验证调整单已创建并审批

### 12.2 前端特有验收标准

AC-FE-001：文件拖拽上传正常
- 验证方式：拖拽文件到上传区域，验证上传成功

AC-FE-002：字段映射调整正确
- 验证方式：修改字段映射，验证预览数据更新

AC-FE-003：错误行高亮显示
- 验证方式：导入有错误的数据，验证错误行高亮
