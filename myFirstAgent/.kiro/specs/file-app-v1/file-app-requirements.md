# file-app 需求文档

> Jira Issue: WCS-1636  
> 版本: 1.0  
> 日期: 2025-12-17

## 1. 项目背景与目标

### 1.1 背景

现有 wcs-app 中包含文件管理功能（FileController），支持本地存储和外部存储（FILE_APP）两种模式。为了实现服务解耦和独立部署，需要将文件管理功能抽离为独立的 file-app 服务。

### 1.2 目标

设计并实现一个独立的文件管理服务（file-app），提供文件上传、下载、预览、更新、删除等功能。

### 1.3 范围

- **包含**：本地文件存储的完整 CRUD 功能
- **不包含**：外部存储（如 FILE_APP 第三方服务）

---

## 2. 功能需求

### 2.1 文件上传

#### FR-001: 单文件上传

| 项目 | 描述 |
|------|------|
| 用户故事 | 作为用户，我希望能上传单个文件到服务器，以便后续使用 |
| 接口 | `POST /file/upload` |
| 输入 | file (必填): 文件内容<br>directory (可选): 存储子目录 |
| 输出 | 文件元数据（id, fileName, fileType, fileSize, filePath） |
| 验收标准 | 1. 文件成功保存到本地磁盘<br>2. 返回文件唯一标识 ID<br>3. 支持指定子目录存储 |

#### FR-002: 多文件上传

| 项目 | 描述 |
|------|------|
| 用户故事 | 作为用户，我希望能一次上传多个文件，提高操作效率 |
| 接口 | `POST /file/upload-multiple` |
| 输入 | files (必填): 文件数组<br>directory (可选): 存储子目录 |
| 输出 | 文件元数据列表 |
| 验收标准 | 1. 所有文件成功保存<br>2. 返回所有文件的元数据<br>3. 单个文件失败不影响其他文件 |


### 2.2 文件下载与预览

#### FR-003: 文件下载/预览

| 项目 | 描述 |
|------|------|
| 用户故事 | 作为用户，我希望能下载或在线预览已上传的文件 |
| 接口 | `GET /file/download/{fileId}` |
| 输入 | fileId (必填): 文件ID<br>forceDownload (可选): 是否强制下载，默认 false |
| 输出 | 文件二进制流 |
| 验收标准 | 1. 图片/视频默认在线预览（inline）<br>2. 其他类型默认下载（attachment）<br>3. forceDownload=true 时强制下载<br>4. 正确设置 Content-Type 和 Content-Disposition |

### 2.3 文件查询

#### FR-004: 获取单个文件详情

| 项目 | 描述 |
|------|------|
| 用户故事 | 作为用户，我希望能查看文件的详细信息 |
| 接口 | `GET /file/{fileId}` |
| 输入 | fileId (必填): 文件ID |
| 输出 | 文件元数据（不含文件内容） |
| 验收标准 | 1. 返回完整的文件元数据<br>2. 文件不存在时返回 404 |

#### FR-005: 批量获取文件详情

| 项目 | 描述 |
|------|------|
| 用户故事 | 作为用户，我希望能一次查询多个文件的信息 |
| 接口 | `GET /files` |
| 输入 | fileIds (必填): 文件ID列表 |
| 输出 | 文件元数据列表 |
| 验收标准 | 1. 返回所有存在文件的元数据<br>2. 不存在的文件ID被忽略 |

### 2.4 文件更新

#### FR-006: 更新文件元数据

| 项目 | 描述 |
|------|------|
| 用户故事 | 作为用户，我希望能修改文件名等元数据 |
| 接口 | `PUT /file/{fileId}` |
| 输入 | fileId (必填): 文件ID<br>body: { fileName: 新文件名 } |
| 输出 | 更新后的文件元数据 |
| 验收标准 | 1. 文件名成功更新<br>2. 物理文件不变<br>3. 文件不存在时返回 404 |

#### FR-007: 更新文件内容

| 项目 | 描述 |
|------|------|
| 用户故事 | 作为用户，我希望能替换已上传文件的内容 |
| 接口 | `POST /file/{fileId}/content` |
| 输入 | fileId (必填): 文件ID<br>file (必填): 新文件内容 |
| 输出 | 更新后的文件元数据 |
| 验收标准 | 1. 物理文件被替换<br>2. 元数据（fileName, fileType, fileSize）更新<br>3. 文件ID保持不变 |

#### FR-008: 批量更新文件元数据

| 项目 | 描述 |
|------|------|
| 用户故事 | 作为用户，我希望能一次修改多个文件的元数据 |
| 接口 | `PUT /files` |
| 输入 | body: [{ id, fileName }, ...] |
| 输出 | 更新后的文件元数据列表 |
| 验收标准 | 1. 所有文件元数据成功更新<br>2. 单个失败不影响其他文件 |


### 2.5 文件删除

#### FR-009: 删除单个文件

| 项目 | 描述 |
|------|------|
| 用户故事 | 作为用户，我希望能删除不需要的文件 |
| 接口 | `DELETE /file/{fileId}` |
| 输入 | fileId (必填): 文件ID |
| 输出 | 无 |
| 验收标准 | 1. 数据库记录被删除<br>2. 物理文件被删除<br>3. 文件不存在时返回 404 |

#### FR-010: 批量删除文件

| 项目 | 描述 |
|------|------|
| 用户故事 | 作为用户，我希望能一次删除多个文件 |
| 接口 | `DELETE /files` |
| 输入 | fileIds (必填): 文件ID列表 |
| 输出 | 无 |
| 验收标准 | 1. 所有文件被删除<br>2. 单个失败不影响其他文件 |

---

## 3. 非功能需求

### 3.1 性能需求

| 编号 | 需求 | 指标 |
|------|------|------|
| NFR-001 | 单文件上传响应时间 | < 3秒（100MB 文件） |
| NFR-002 | 文件下载吞吐量 | 支持 100 并发下载 |
| NFR-003 | 元数据查询响应时间 | < 100ms |

### 3.2 安全需求

| 编号 | 需求 | 描述 |
|------|------|------|
| NFR-004 | 文件类型校验 | 可配置允许的文件类型白名单 |
| NFR-005 | 文件大小限制 | 可配置单文件和请求总大小限制 |
| NFR-006 | 路径安全 | 防止路径遍历攻击 |

### 3.3 可用性需求

| 编号 | 需求 | 描述 |
|------|------|------|
| NFR-007 | 存储目录自动创建 | 目录不存在时自动创建 |
| NFR-008 | 文件名冲突处理 | 使用 UUID 前缀避免冲突 |
| NFR-009 | 错误信息友好 | 返回清晰的错误码和消息 |

---

## 4. 约束条件

### 4.1 技术约束

| 约束 | 描述 |
|------|------|
| 存储方式 | **仅支持本地文件存储**，不支持外部存储服务 |
| 技术栈 | Spring Boot 3.x + Java 21 |
| ORM | MyBatis-Plus |
| 对象映射 | MapStruct |
| 架构模式 | DDD 分层架构（rest/application/domain/infrastructure） |

### 4.2 业务约束

| 约束 | 描述 |
|------|------|
| 文件ID | 使用 UUID（32位字符串） |
| 存储路径 | 绝对路径存储在数据库中 |
| 文件命名 | {UUID}-{原始文件名} |

---

## 5. 验收标准

### 5.1 功能验收

- [ ] 10 个 API 接口全部实现并可用
- [ ] 单元测试覆盖率 > 80%
- [ ] 接口文档完整（Swagger/OpenAPI）

### 5.2 非功能验收

- [ ] 100MB 文件上传成功
- [ ] 并发下载测试通过
- [ ] 安全测试通过（路径遍历、文件类型校验）

### 5.3 文档验收

- [ ] API 接口文档
- [ ] 部署文档
- [ ] 配置说明文档
