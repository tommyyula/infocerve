---
inclusion: fileMatch
fileMatchPattern: "**/**.md"
---

# 🎨 设计规范

> **核心理念**：设计重思路，不拘泥于代码规范；不确定立即确认
> **重要**：设计文档跟随 task-manager 思考结果（research_mode + process_thought），不能自作主张

---

## 🎯 设计阶段原则

| 要做 | 不要做 |
|------|--------|
| ✅ 快速表达实现思路 | ❌ 追求完美代码结构 |
| ✅ 展示业务流程 | ❌ 直接照抄到最终代码 |
| ✅ 标注不确定的地方 | ❌ 猜测后继续往下做 |
| ✅ 使用 task-manager 思考 | ❌ 自作主张写设计 |

---

## 📝 设计阶段允许的简化

| 设计阶段可以 | 编码阶段必须 |
|-------------|-------------|
| `user.setStatus("0")` | `user.enable()` 业务方法 |
| 省略部分注释 | 完整 JavaDoc |
| Application Service 写逻辑 | 充血模型，逻辑在实体 |

**记住**：设计文档 = 思路草图，不是最终代码

---

## 🔄 设计变更必须同步

- 需求变更 → 更新 `requirements.md`
- 设计变更 → 更新 `design.md`
- 用户确认的决策 → 记录到文档
- 迭代反馈发现问题 → 同步更新设计

---

## 可靠性设计原则 - WAL 思想

WAL（Write Ahead Log）思想：写数据前先记录"日志"，确保上下文不丢失、可恢复。

应用场景：
- 异步任务下发前，先记录任务日志表
- 回调处理前，先记录回调日志
- 关键状态变更前，先记录变更日志

好处：
- 上下文不容易丢失
- 可恢复性好
- 可靠性高

实现方式：
- 日志表（如 device_callback_log）
- 业务日志（log.info 关键节点）
- 状态机 + 日志双写

---

## 设计完成检查

- [ ] 使用了 research_mode + process_thought 思考？
- [ ] 表达了核心思路？
- [ ] 展示了业务流程？
- [ ] 标注了不确定的地方？
- [ ] 与用户确认了所有不确定问题？

---

## 模块归属判断原则

当不确定某个功能应该放在哪个模块时，按以下原则判断：

1. **静态元数据 vs 运行时状态**
   - 静态配置/元数据 -> 放在主数据模块（如 mdm-app）
   - 运行时状态/实例 -> 放在业务模块
   - 示例：ContainerSpec（规格定义）属于主数据，Container（实例）属于业务模块

2. **依赖关系判断**
   - 被多个模块依赖的基础数据 -> 放在 common 或 mdm-app
   - 只被单一模块使用 -> 放在该业务模块

3. **生命周期判断**
   - 系统初始化时创建，很少变更 -> mdm-app
   - 业务运行时频繁创建/变更 -> 业务模块

---

## 二次开发项目检查清单

二次开发项目（基于现有系统扩展或重构功能）必须先做：

1. **功能清单对比** - 列出原系统所有功能，逐一确认开发范围
2. **API 清单对比** - 对比新旧 API，确保不遗漏
3. **数据库表对比** - 对比表结构，确认字段映射
4. **枚举/常量对比** - 确保业务枚举完整覆盖

---

## 反思次数要求

[重要] 修改设计/需求/任务文档前，必须使用 process_thought 进行充分反思：
- 最少 10 次反思，只能多不能少
- 每次反思要有明确的思考角度（如：完整性、一致性、依赖关系、可行性、风险点）
- 反思完成后才能动手修改文档

---

## 深度思考工具使用经验

1. **复杂设计任务建议 100+ 轮思考**
   - 简单问题：10-30 轮
   - 中等复杂度：50-100 轮
   - 大型二次开发/架构设计：100+ 轮
   - 宁可多思考，不要漏掉关键点

2. **思考要分阶段**
   - 第一阶段：问题定义、范围界定
   - 第二阶段：现状分析、差异识别
   - 第三阶段：方案设计、风险评估
   - 第四阶段：验证检查、查漏补缺

3. **每 N 轮输出一次中间结果**
   - 避免思考太久没有产出
   - 便于用户及时纠偏
   - 建议每 50-100 轮更新一次文档

4. **思考过程要留痕**
   - 关键决策记录到设计文档
   - 被否决的方案也要简要说明原因
   - 便于后续回溯和复盘

---

## 文档同步规则

1. **设计文档更新后必须同步任务文档**
   - design.md 变更 -> 检查 tasks/ 目录下所有相关任务文档
   - 任务文档按 DAG（有向无环图）依赖顺序排列

2. **SQL 文件放置规则**
   - 模块专属 SQL -> 放在对应模块目录（如 wcs-app/db-script/）
   - 跨模块公共 SQL -> 放在 common 或专门的 db-script 目录

3. **权限配置集中管理**
   - 新增模块需要完整的权限清单（菜单、按钮、API）
   - 权限 SQL 放在对应模块的 db-script 目录

---

*最后更新：2025-12-26*
