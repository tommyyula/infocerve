# 领域分析编写规范（Domain Analysis Guidelines）

## 概述

本规范定义了领域分析（战略设计）的编写标准，是 DDD 战略设计阶段的核心产出。

### 相关规范

- **DDD 架构规范**：参见 `ddd-architecture.md`
- **用户故事规范**：参见 `story-guidelines.md`
- **TDD 工作流程**：参见 `test-driven-development-workflow.md`

---

## 文件位置

```
.kiro/specs/{feature-name}/domain-analysis.md
```

---

## 模板结构

```markdown
# {功能名称} - 领域分析

## 1. 统一语言（Ubiquitous Language）

| 术语 | 定义 | 英文 |
|-----|------|------|
| 术语1 | 定义说明 | EnglishTerm |

## 2. 领域识别

### 2.1 核心域（Core Domain）
### 2.2 支撑域（Supporting Domain）
### 2.3 通用域（Generic Domain）

## 3. 限界上下文（Bounded Context）

### 3.1 上下文划分
### 3.2 上下文映射（Context Map）
### 3.3 上下文关系类型

## 4. 业务流程

## 5. 业务规则
```

---

## 1. 统一语言（Ubiquitous Language）

### 编写要点

统一语言是团队共同使用的业务术语，确保沟通无歧义。

| 要素 | 说明 | 示例 |
|-----|------|------|
| 术语 | 中文业务名称 | 入库单 |
| 定义 | 清晰的业务含义 | 记录物料入库的单据 |
| 英文 | 代码中使用的名称 | InboundOrder |

### 编写规则

```
✅ 正确：
| 入库单 | 记录物料入库的单据，包含供应商、入库明细等信息 | InboundOrder |

❌ 错误：
| 入库单 | 入库用的单子 | inbound_order |  （定义模糊，英文格式错误）
```

### 术语来源

- 从用户故事中提取业务名词
- 与业务专家确认术语含义
- 参考行业标准术语

---

## 2. 领域识别

### 2.1 核心域（Core Domain）

核心竞争力所在，需要重点投入自研。

```markdown
### 2.1 核心域（Core Domain）

| 领域 | 说明 | 投入策略 |
|-----|------|---------|
| 库存管理 | 实时库存跟踪、库存预警、库存分析 | 自研，精细设计 |
| 入库管理 | 入库流程、收货、上架 | 自研，精细设计 |
```

### 2.2 支撑域（Supporting Domain）

支持核心域运作，但不是核心竞争力。

```markdown
### 2.2 支撑域（Supporting Domain）

| 领域 | 说明 | 投入策略 |
|-----|------|---------|
| 基础数据 | 物料、仓库、库位管理 | 自研，标准设计 |
| 报表统计 | 库存报表、出入库统计 | 自研，标准设计 |
```

### 2.3 通用域（Generic Domain）

可以使用通用方案或外购。

```markdown
### 2.3 通用域（Generic Domain）

| 领域 | 说明 | 投入策略 |
|-----|------|---------|
| 用户认证 | 登录、权限、角色 | 使用成熟方案 |
| 文件存储 | 附件、图片 | 使用云存储 |
```

### 领域分类判断标准

| 问题 | 核心域 | 支撑域 | 通用域 |
|-----|-------|-------|-------|
| 是否核心竞争力？ | ✅ 是 | ❌ 否 | ❌ 否 |
| 是否需要定制？ | ✅ 高度定制 | ⚠️ 部分定制 | ❌ 标准方案 |
| 能否外购？ | ❌ 不能 | ⚠️ 可考虑 | ✅ 推荐 |
| 投入优先级 | 🔴 最高 | 🟡 中等 | 🟢 最低 |

---

## 3. 限界上下文（Bounded Context）

### 3.1 上下文划分

使用表格描述每个上下文的职责和核心概念。

```markdown
### 3.1 上下文划分

| 上下文 | 职责 | 核心概念 | 所属领域 |
|-------|------|---------|---------|
| 入库上下文 | 入库单管理、收货流程 | InboundOrder, Receipt | 核心域 |
| 库存上下文 | 库存数量管理、库存变动 | Inventory, Transaction | 核心域 |
| 基础数据上下文 | 物料、仓库、库位管理 | Item, Warehouse, Location | 支撑域 |
```

### 3.2 上下文映射（Context Map）

使用 ASCII 图或文字描述上下文之间的关系。

```markdown
### 3.2 上下文映射（Context Map）

```
┌─────────────────┐
│  基础数据上下文  │
│  (Master Data)  │
└────────┬────────┘
         │ OHS (开放主机服务)
         ↓
┌─────────────────┐     U/D      ┌─────────────────┐
│   入库上下文     │ ──────────→ │   库存上下文     │
│  (Inbound)      │             │  (Inventory)    │
└─────────────────┘             └─────────────────┘
```
```

### 3.3 上下文关系类型

| 关系类型 | 缩写 | 说明 | 使用场景 |
|---------|------|------|---------|
| 合作关系 | Partnership | 两个上下文紧密合作，共同演进 | 同一团队维护的紧密相关上下文 |
| 共享内核 | SK | 共享部分模型代码 | 多个上下文共用核心概念 |
| 客户-供应商 | U/D | 下游依赖上游，上游需考虑下游需求 | 入库→库存（入库完成后更新库存） |
| 遵奉者 | Conformist | 下游完全遵从上游模型 | 集成第三方系统，无法影响其设计 |
| 防腐层 | ACL | 隔离外部系统，转换模型 | 与 ERP、外部 API 集成 |
| 开放主机服务 | OHS | 提供标准化 API 供多方使用 | 基础数据供多个上下文使用 |
| 发布语言 | PL | 定义标准的数据交换格式 | 跨系统数据交换 |

---

## 4. 业务流程

业务流程设计是领域分析的核心内容，需要从多个维度描述业务如何运作。

### 4.1 端到端业务流程

描述完整的业务流程，包括多个阶段、多个角色、多个系统的协作。

```markdown
### 4.1 端到端业务流程

#### {流程名称}完整流程

```
┌─────────────────────────────────────────────────────────────────┐
│ 阶段1：{阶段名称}（{操作端}）                                      │
├─────────────────────────────────────────────────────────────────┤
│ 1. {步骤描述}                                                    │
│ 2. {步骤描述}                                                    │
│ 3. {步骤描述} → {触发动作}                                        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 阶段2：{阶段名称}（{操作端}）                                      │
├─────────────────────────────────────────────────────────────────┤
│ 4. {步骤描述}                                                    │
│ 5. {步骤描述}                                                    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 阶段3：{阶段名称}（{操作端}）                                      │
├─────────────────────────────────────────────────────────────────┤
│ 6. {步骤描述}                                                    │
│ 7. {步骤描述}                                                    │
└─────────────────────────────────────────────────────────────────┘
```
```

**示例：收货完整流程**

```markdown
```
┌─────────────────────────────────────────────────────────────────┐
│ 阶段1：收货准备（PC端/Web端）                                     │
├─────────────────────────────────────────────────────────────────┤
│ 1. 接收来源单据（ASN/PO/RMA 从 OMS 同步）                         │
│ 2. 创建收货单（关联来源单据或盲收）                                │
│ 3. 确认收货单 → 自动生成收货任务                                  │
│ 4. 分配任务给收货员                                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 阶段2：任务执行（手持端/PDA）                                     │
├─────────────────────────────────────────────────────────────────┤
│ 5. 收货员查看待执行任务列表                                       │
│ 6. 扫描物料条码/SSCC → 匹配任务                                  │
│ 7. 采集数据：批次号、序列号(SN)、效期、实收数量                    │
│ 8. 扫描上架库位                                                  │
│ 9. 提交执行结果（支持多次分批执行）                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 阶段3：收货完成（系统自动）                                       │
├─────────────────────────────────────────────────────────────────┤
│ 10. 任务完成 → 汇总回写收货单明细                                 │
│ 11. 所有任务完成 → 收货单状态变为已完成                           │
│ 12. 发布领域事件 → 更新库存、通知 OMS                             │
└─────────────────────────────────────────────────────────────────┘
```
```

### 4.2 多端协作模型

描述不同终端、不同角色在业务流程中的职责分工。

```markdown
### 4.2 多端协作模型

| 端 | 角色 | 主要操作 | 典型场景 |
|---|------|---------|---------|
| PC/Web | 仓库管理员 | 创建单据、确认、分配任务、查询、异常处理 | 办公室操作 |
| 手持端/PDA | 操作员 | 查看任务、扫描、采集数据、执行操作 | 仓库现场操作 |
| 系统 | 自动 | 生成任务、汇总数据、更新库存、发布事件 | 后台自动处理 |
| 外部系统 | OMS/ERP | 推送单据、接收回执 | 系统集成 |
```

### 4.3 任务驱动模型

对于需要现场执行的业务，描述任务的生成、分配、执行、完成流程。

```markdown
### 4.3 任务驱动模型

#### 任务生命周期

```
[单据确认] → [生成任务] → [分配任务] → [执行任务] → [完成任务] → [汇总回写]
```

#### 任务类型

| 任务类型 | 触发时机 | 执行端 | 采集数据 |
|---------|---------|-------|---------|
| 收货任务 | 收货单确认 | 手持端 | 批次、SN、效期、数量、库位 |
| 上架任务 | 收货完成 | 手持端 | 目标库位 |
| 拣货任务 | 出库单确认 | 手持端 | 实拣数量、SN |
| 盘点任务 | 盘点单创建 | 手持端 | 实盘数量 |

#### 任务执行模式

| 模式 | 说明 | 适用场景 |
|-----|------|---------|
| 单次执行 | 一次完成全部数量 | 小批量、整托收货 |
| 多次执行 | 分多次完成 | 大批量、分批到货 |
| 并行执行 | 多人同时执行 | 紧急任务、大批量 |
```

### 4.4 事件风暴格式

使用命令→事件→策略的格式描述业务流程的核心交互。

```markdown
### 4.4 事件风暴

```
[命令]              [事件]                [策略/后续动作]
创建收货单    →    收货单已创建      →    等待确认
    ↓
确认收货单    →    收货单已确认      →    生成收货任务
    ↓
执行收货任务  →    任务执行完成      →    汇总到收货单
    ↓
完成收货单    →    收货单已完成      →    更新库存、发布事件
```
```

### 4.5 流程说明表

详细描述每个步骤的触发者、前置条件、后置动作。

```markdown
### 4.5 流程说明

| 步骤 | 触发者 | 操作端 | 前置条件 | 后置动作 |
|-----|-------|-------|---------|---------|
| 创建收货单 | 仓库管理员 | PC | 来源单据存在 | 生成单号，状态=草稿 |
| 确认收货单 | 仓库管理员 | PC | 至少一条明细 | 状态=待执行，生成任务 |
| 执行收货任务 | 收货员 | 手持端 | 任务已分配 | 采集数据，更新任务 |
| 完成收货单 | 系统 | 自动 | 所有任务完成 | 状态=已完成，更新库存 |
```

### 流程图要素

| 要素 | 符号 | 说明 |
|-----|------|------|
| 命令 | [命令名] | 用户或系统发起的动作 |
| 事件 | 事件名 | 命令执行后产生的结果 |
| 策略 | 策略名 | 事件触发的后续处理 |
| 聚合 | 《聚合名》 | 处理命令的聚合 |
| 阶段 | 阶段N | 流程的不同阶段 |
| 操作端 | (端名) | 执行操作的终端 |

---

## 5. 业务规则

### 编写格式

使用编号标识业务规则，便于在需求和测试中引用。

```markdown
## 5. 业务规则

### 5.1 入库规则

| 编号 | 规则描述 | 触发场景 |
|-----|---------|---------|
| BR-IN-001 | 入库数量不能为负数 | 录入收货数量时 |
| BR-IN-002 | 入库数量不能超过计划数量的 110% | 提交收货时 |
| BR-IN-003 | 只有"草稿"状态的入库单可以修改 | 编辑入库单时 |
| BR-IN-004 | 确认入库单前必须至少有一条明细 | 确认入库单时 |

### 5.2 库存规则

| 编号 | 规则描述 | 触发场景 |
|-----|---------|---------|
| BR-INV-001 | 库存数量不能为负数 | 出库扣减时 |
| BR-INV-002 | 库存低于安全库存时触发预警 | 库存变动后 |
```

### 规则编号规范

```
BR-{上下文缩写}-{序号}

示例：
BR-IN-001   入库上下文第1条规则
BR-OUT-001  出库上下文第1条规则
BR-INV-001  库存上下文第1条规则
```

---

## 完整示例

```markdown
# 入库管理 - 领域分析

## 1. 统一语言（Ubiquitous Language）

| 术语 | 定义 | 英文 |
|-----|------|------|
| 入库单 | 记录物料入库的单据，包含供应商、入库明细等信息 | InboundOrder |
| 入库明细 | 入库单中的一条物料记录，包含物料、计划数量、实收数量 | InboundOrderLine |
| 收货任务 | 分配给收货员执行的具体收货工作 | ReceivingTask |
| 任务执行 | 收货员在手持端完成的一次收货操作记录 | TaskExecution |
| 收货 | 入库单执行过程中的实际收货动作 | Receipt |
| 上架 | 将收到的物料放置到指定库位的动作 | Putaway |
| 供应商 | 提供物料的外部单位 | Supplier |

## 2. 领域识别

### 2.1 核心域（Core Domain）

| 领域 | 说明 | 投入策略 |
|-----|------|---------|
| 入库管理 | 入库流程、收货、上架 | 自研，精细设计 |
| 库存管理 | 实时库存跟踪、库存预警 | 自研，精细设计 |

### 2.2 支撑域（Supporting Domain）

| 领域 | 说明 | 投入策略 |
|-----|------|---------|
| 基础数据 | 物料、仓库、库位、供应商管理 | 自研，标准设计 |
| 任务管理 | 任务生成、分配、执行跟踪 | 自研，标准设计 |

### 2.3 通用域（Generic Domain）

| 领域 | 说明 | 投入策略 |
|-----|------|---------|
| 用户认证 | 登录、权限 | 使用成熟方案 |

## 3. 限界上下文（Bounded Context）

### 3.1 上下文划分

| 上下文 | 职责 | 核心概念 |
|-------|------|---------|
| 入库上下文 | 入库单管理、收货流程 | InboundOrder, ReceivingTask |
| 库存上下文 | 库存数量管理 | Inventory, InventoryTransaction |
| 基础数据上下文 | 物料、仓库、库位管理 | Item, Warehouse, Location, Supplier |

### 3.2 上下文映射（Context Map）

```
┌─────────────────┐
│  基础数据上下文  │
└────────┬────────┘
         │ OHS
    ┌────┴────┐
    ↓         ↓
┌────────┐  ┌────────┐
│ 入库   │→│ 库存   │
│ 上下文 │U/D│ 上下文 │
└────────┘  └────────┘
```

### 3.3 上下文关系

| 上游 | 下游 | 关系类型 | 说明 |
|-----|------|---------|------|
| 基础数据 | 入库 | OHS | 入库引用物料、供应商信息 |
| 基础数据 | 库存 | OHS | 库存引用物料、库位信息 |
| 入库 | 库存 | U/D | 入库完成后更新库存 |

## 4. 业务流程

### 4.1 端到端业务流程

#### 入库完整流程

```
┌─────────────────────────────────────────────────────────────────┐
│ 阶段1：入库准备（PC端/Web端）                                     │
├─────────────────────────────────────────────────────────────────┤
│ 1. 接收来源单据（ASN/PO 从 OMS 同步）                             │
│ 2. 创建入库单（关联来源单据）                                     │
│ 3. 确认入库单 → 自动生成收货任务                                  │
│ 4. 分配任务给收货员                                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 阶段2：任务执行（手持端/PDA）                                     │
├─────────────────────────────────────────────────────────────────┤
│ 5. 收货员查看待执行任务列表                                       │
│ 6. 扫描物料条码 → 匹配任务                                       │
│ 7. 采集数据：批次号、序列号(SN)、效期、实收数量                    │
│ 8. 扫描上架库位                                                  │
│ 9. 提交执行结果（支持多次分批执行）                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ 阶段3：入库完成（系统自动）                                       │
├─────────────────────────────────────────────────────────────────┤
│ 10. 任务完成 → 汇总回写入库单明细                                 │
│ 11. 所有任务完成 → 入库单状态变为已完成                           │
│ 12. 发布领域事件 → 更新库存、通知 OMS                             │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 多端协作模型

| 端 | 角色 | 主要操作 | 典型场景 |
|---|------|---------|---------|
| PC/Web | 仓库管理员 | 创建入库单、确认、分配任务、查询、异常处理 | 办公室操作 |
| 手持端/PDA | 收货员 | 查看任务、扫描、采集数据、执行收货 | 仓库现场操作 |
| 系统 | 自动 | 生成任务、汇总数据、更新库存、发布事件 | 后台自动处理 |

### 4.3 任务驱动模型

#### 收货任务生命周期

```
[入库单确认] → [生成任务] → [分配任务] → [执行任务] → [完成任务] → [汇总回写]
```

#### 任务执行模式

| 模式 | 说明 | 适用场景 |
|-----|------|---------|
| 单次执行 | 一次完成全部数量 | 小批量、整托收货 |
| 多次执行 | 分多次完成 | 大批量、分批到货 |

### 4.4 事件风暴

```
[命令]              [事件]                [策略/后续动作]
创建入库单    →    入库单已创建      →    等待确认
    ↓
确认入库单    →    入库单已确认      →    生成收货任务
    ↓
执行收货任务  →    任务执行完成      →    汇总到入库单
    ↓
完成入库单    →    入库单已完成      →    更新库存、发布事件
```

### 4.5 流程说明

| 步骤 | 触发者 | 操作端 | 前置条件 | 后置动作 |
|-----|-------|-------|---------|---------|
| 创建入库单 | 仓库管理员 | PC | 来源单据存在 | 生成单号，状态=草稿 |
| 确认入库单 | 仓库管理员 | PC | 至少一条明细 | 状态=待执行，生成任务 |
| 执行收货任务 | 收货员 | 手持端 | 任务已分配 | 采集数据，更新任务 |
| 完成入库单 | 系统 | 自动 | 所有任务完成 | 状态=已完成，更新库存 |

## 5. 业务规则

| 编号 | 规则描述 | 触发场景 |
|-----|---------|---------|
| BR-IN-001 | 入库数量不能为负数 | 录入收货数量时 |
| BR-IN-002 | 入库数量不能超过计划数量的 110% | 提交收货时 |
| BR-IN-003 | 只有"草稿"状态的入库单可以修改明细 | 编辑入库单时 |
| BR-IN-004 | 确认入库单前必须至少有一条明细 | 确认入库单时 |
| BR-IN-005 | 入库单号格式：IN + 年月日 + 4位序号 | 创建入库单时 |
| BR-IN-006 | 任务执行时必须采集批次号（如物料启用批次管理） | 执行任务时 |
| BR-IN-007 | 任务执行时必须采集序列号（如物料启用序列号管理） | 执行任务时 |
```

---

## 检查清单

### 统一语言
- [ ] 所有业务术语都有明确定义
- [ ] 英文命名符合 PascalCase 规范
- [ ] 术语与用户故事中使用的一致

### 领域识别
- [ ] 明确区分核心域、支撑域、通用域
- [ ] 每个领域有明确的投入策略

### 限界上下文
- [ ] 每个上下文职责清晰、边界明确
- [ ] 上下文之间的关系类型正确
- [ ] 上下文映射图清晰

### 业务流程
- [ ] 端到端业务流程完整描述
- [ ] 多端协作模型清晰（PC端、手持端、系统自动）
- [ ] 任务驱动模型明确（如有任务执行场景）
- [ ] 命令、事件、策略对应清晰
- [ ] 流程步骤的触发者、操作端、前置条件、后置动作明确

### 业务规则
- [ ] 所有业务规则有唯一编号
- [ ] 规则描述清晰、可测试
- [ ] 触发场景明确

---

## 常见问题

### Q: 如何判断两个概念是否属于同一个上下文？
A: 如果两个概念在业务上紧密相关，且通常一起变化，则属于同一上下文。如果它们可以独立演进，则应分开。

### Q: 上下文之间如何通信？
A: 通过领域事件异步通信，或通过 API 同步调用。避免直接引用其他上下文的领域对象。

### Q: 业务规则应该写多详细？
A: 写到可以直接转化为验收标准和测试用例的程度。模糊的规则后续会导致理解偏差。

---

## 下一步

完成 `domain-analysis.md` 后，进入需求规格阶段，编写 `requirements.md`。
