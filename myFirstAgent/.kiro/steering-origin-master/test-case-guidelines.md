# 测试用例编写规范（Test Case Guidelines）

## 概述

本规范定义了测试用例文档的编写标准，包括 E2E 测试、单元测试和 API 测试。

### 相关规范

- **需求规格规范**：参见 `requirements-guidelines.md`
- **技术设计规范**：参见 `design-guidelines.md`
- **TDD 工作流程**：参见 `test-driven-development-workflow.md`

---

## 文件位置

```
.kiro/specs/{feature-name}/
├── e2e-test-cases.md          # 端到端测试用例
├── unit-test-cases.md         # 单元测试用例
└── api-test-cases.md          # API 测试用例
```

---

## 测试金字塔

```
        /\
       /  \
      / E2E \        少量，验证核心流程
     /--------\
    /   API    \     中量，验证接口契约
   /--------------\
  /     Unit       \  大量，验证业务逻辑
 /------------------\
```

| 测试类型 | 数量 | 执行速度 | 覆盖范围 |
|---------|------|---------|---------|
| E2E | 少 | 慢 | 端到端流程 |
| API | 中 | 中 | 接口契约 |
| Unit | 多 | 快 | 业务逻辑 |

---

## E2E 测试用例

### 文件：e2e-test-cases.md

### 模板

```markdown
# {功能名称} - E2E 测试用例

## 测试范围

- 覆盖核心业务流程
- 验证多端协作场景
- 验证系统集成

---

## 测试用例列表

### E2E-001: {测试标题}

**关联需求**：需求 X.Y
**关联故事**：Story X
**优先级**：P0/P1/P2

**前置条件**：
- 条件1
- 条件2

**测试步骤**：
1. 步骤1
2. 步骤2
3. 步骤3

**预期结果**：
- 结果1
- 结果2

**测试数据**：
- 数据1
- 数据2
```

### 示例

```markdown
### E2E-001: ASN 收货完整流程

**关联需求**：需求 1、需求 6
**关联故事**：Story 1、Story 6
**优先级**：P0

**前置条件**：
- 用户已登录（仓库管理员）
- 存在待收货的 ASN 单据
- 存在可用的上架库位

**测试步骤**：
1. PC 端：进入收货管理页面
2. PC 端：选择 ASN 单据，创建收货单
3. PC 端：确认收货单，系统生成收货任务
4. PC 端：分配任务给收货员
5. 手持端：收货员登录，查看任务列表
6. 手持端：扫描物料条码，匹配任务
7. 手持端：输入批次号、效期、实收数量
8. 手持端：扫描上架库位
9. 手持端：提交执行结果
10. 系统：任务完成，收货单状态变为已完成
11. 系统：库存增加

**预期结果**：
- 收货单状态为"已完成"
- 收货任务状态为"已完成"
- 对应库位库存增加
- ASN 状态更新为"已收货"

**测试数据**：
- ASN 单号：ASN20241231001
- 物料：ITEM-001，计划数量 100
- 批次号：BAT20241231
- 效期：2025-12-31
- 库位：A-01-01-01
```

### E2E 测试用例编写规则

1. **覆盖核心流程**：优先覆盖主要业务流程
2. **多端协作**：包含 PC 端和手持端的协作场景
3. **数据准备**：明确前置条件和测试数据
4. **结果验证**：验证所有相关系统的状态变化

---

## 单元测试用例

### 文件：unit-test-cases.md

### 模板

```markdown
# {功能名称} - 单元测试用例

## 测试范围

- 领域层：聚合、实体、值对象、领域服务
- 应用层：应用服务

---

## 值对象测试

### UT-VO-001: {值对象名} - {测试场景}

**关联值对象**：{值对象名}
**测试类型**：值对象测试

**测试场景**：
- 场景描述

**输入**：
- 输入数据

**预期结果**：
- 预期输出或异常

---

## 聚合测试

### UT-AGG-001: {聚合名} - {测试场景}

**关联聚合**：{聚合名}
**关联方法**：{方法名}
**关联业务规则**：BR-XXX-001
**测试类型**：聚合根测试

**测试场景**：
- 场景描述

**前置状态**：
- 聚合初始状态

**输入**：
- 方法参数

**预期结果**：
- 状态变化
- 事件发布

---

## 领域服务测试

### UT-DS-001: {服务名} - {测试场景}

**关联服务**：{服务名}
**关联方法**：{方法名}
**测试类型**：领域服务测试

**测试场景**：
- 场景描述

**Mock 依赖**：
- 依赖1
- 依赖2

**输入**：
- 方法参数

**预期结果**：
- 返回值或异常
```

### 示例

```markdown
## 值对象测试

### UT-VO-001: Quantity - 不能为负数

**关联值对象**：Quantity
**测试类型**：值对象测试

**测试场景**：
- 创建负数数量时应抛出异常

**输入**：
- value = -1

**预期结果**：
- 抛出 IllegalArgumentException
- 异常消息包含"不能为负数"

### UT-VO-002: Quantity - 加法运算

**关联值对象**：Quantity
**测试类型**：值对象测试

**测试场景**：
- 两个数量相加返回新的数量对象

**输入**：
- quantity1 = 10
- quantity2 = 5

**预期结果**：
- 返回新的 Quantity 对象
- 值为 15
- 原对象不变

---

## 聚合测试

### UT-AGG-001: Receipt - 确认收货单

**关联聚合**：Receipt
**关联方法**：confirm()
**关联业务规则**：BR-RCV-003, BR-RCV-004
**测试类型**：聚合根测试

**测试场景**：
- 草稿状态的收货单可以确认

**前置状态**：
- 收货单状态 = DRAFT
- 收货单有 1 条明细

**输入**：
- 无参数

**预期结果**：
- 状态变为 CONFIRMED
- 发布 ReceiptConfirmedEvent

### UT-AGG-002: Receipt - 确认收货单失败（无明细）

**关联聚合**：Receipt
**关联方法**：confirm()
**关联业务规则**：BR-RCV-004
**测试类型**：聚合根测试

**测试场景**：
- 没有明细的收货单不能确认

**前置状态**：
- 收货单状态 = DRAFT
- 收货单无明细

**输入**：
- 无参数

**预期结果**：
- 抛出 BusinessException
- 异常消息包含"至少有一条明细"

---

## 领域服务测试

### UT-DS-001: ReceivingDomainService - 校验容差（在范围内）

**关联服务**：ReceivingDomainService
**关联方法**：validateTolerance()
**测试类型**：领域服务测试

**测试场景**：
- 实收数量在容差范围内，校验通过

**Mock 依赖**：
- ReceivingConfigRepository.findTolerance() 返回 Tolerance(5%, false)

**输入**：
- plannedQuantity = 100
- actualQuantity = 103

**预期结果**：
- 返回 ValidationResult.success()
```

### 单元测试用例编写规则

1. **按类型分组**：值对象、聚合、领域服务分开
2. **关联业务规则**：每个测试关联具体的业务规则
3. **正反用例**：包含正常场景和异常场景
4. **状态验证**：验证状态变化和事件发布

---

## API 测试用例

### 文件：api-test-cases.md

### 模板

```markdown
# {功能名称} - API 测试用例

## 测试范围

- BFF 层 API
- 后端 API

---

## API 测试用例列表

### API-001: {API 名称} - {测试场景}

**关联需求**：需求 X.Y
**API**：{METHOD} {PATH}
**测试类型**：正常/异常/边界

**请求**：
```json
{
  "field": "value"
}
```

**预期响应**：
- HTTP 状态码：200
- 响应体：
```json
{
  "code": 200,
  "data": {}
}
```

**验证点**：
- 验证点1
- 验证点2
```

### 示例

```markdown
### API-001: 创建收货单 - 正常创建

**关联需求**：需求 1
**API**：POST /api/v1/receipts
**测试类型**：正常

**请求**：
```json
{
  "receiptType": "ASN",
  "sourceDocumentId": "asn-001",
  "sourceDocumentNo": "ASN20241231001",
  "warehouseId": "wh-001",
  "lines": [
    {
      "itemId": "item-001",
      "plannedQuantity": 100
    }
  ]
}
```

**预期响应**：
- HTTP 状态码：200
- 响应体：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "rcv-xxx",
    "receiptNo": "RCV20241231000001",
    "status": "DRAFT"
  }
}
```

**验证点**：
- 返回收货单 ID
- 收货单号格式正确
- 状态为 DRAFT

### API-002: 创建收货单 - 来源单据不存在

**关联需求**：需求 1
**API**：POST /api/v1/receipts
**测试类型**：异常

**请求**：
```json
{
  "receiptType": "ASN",
  "sourceDocumentId": "not-exist",
  "warehouseId": "wh-001",
  "lines": []
}
```

**预期响应**：
- HTTP 状态码：400
- 响应体：
```json
{
  "code": 400,
  "message": "来源单据不存在",
  "errorCode": "RCV_005"
}
```

**验证点**：
- 返回 400 状态码
- 错误码为 RCV_005
```

### API 测试用例编写规则

1. **覆盖所有 API**：每个 API 至少有正常和异常用例
2. **请求响应完整**：包含完整的请求和响应示例
3. **验证点明确**：明确需要验证的内容
4. **边界测试**：包含边界值测试

---

## 测试用例编号规范

| 类型 | 前缀 | 示例 |
|-----|------|------|
| E2E 测试 | E2E- | E2E-001 |
| 值对象测试 | UT-VO- | UT-VO-001 |
| 聚合测试 | UT-AGG- | UT-AGG-001 |
| 领域服务测试 | UT-DS- | UT-DS-001 |
| 应用服务测试 | UT-AS- | UT-AS-001 |
| API 测试 | API- | API-001 |

---

## 优先级定义

| 优先级 | 说明 | 执行时机 |
|-------|------|---------|
| P0 | 核心功能，必须通过 | 每次提交 |
| P1 | 重要功能，应该通过 | 每次提交 |
| P2 | 一般功能，建议通过 | 发布前 |
| P3 | 边缘场景，可选 | 定期执行 |

---

## 检查清单

### E2E 测试
- [ ] 覆盖核心业务流程
- [ ] 包含多端协作场景
- [ ] 前置条件完整
- [ ] 测试数据明确

### 单元测试
- [ ] 覆盖所有值对象
- [ ] 覆盖所有聚合方法
- [ ] 覆盖所有领域服务
- [ ] 包含正常和异常场景
- [ ] 关联业务规则

### API 测试
- [ ] 覆盖所有 API
- [ ] 包含正常、异常、边界场景
- [ ] 请求响应示例完整
- [ ] 验证点明确

---

## 下一步

完成测试用例文档后，进入实现阶段，编写 `tasks.md`。
