---
inclusion: manual
---

# 任务执行与状态管理规范

本规范定义了任务执行的具体实现细节，包括任务粒度拆分、状态持久化、Session 恢复等。

## 任务粒度拆分规则

### 粒度原则

| 原则 | 说明 | 要求 |
|-----|------|-----|
| 单一职责 | 每个任务只做一件事 | 必须 |
| 时间限制 | 单个任务不超过 10 分钟 | 必须 |
| 可验证 | 有明确的验证方式 | 必须 |
| 可恢复 | 状态可持久化 | 必须 |

### 任务层级

```
Story（用户故事）
  └── Epic（30-60 分钟）
        └── Task（10-15 分钟）
              └── SubTask（3-5 分钟）
                    └── Step（1-2 分钟）
```

### 子任务类型

| 类型 | 描述 | 时间 |
|-----|------|-----|
| 创建文件 | 单个文件（接口/类型/组件） | 2-3 分钟 |
| 实现函数 | 单个函数（≤50 行） | 3-5 分钟 |
| 编写测试 | 单个测试用例 | 2-3 分钟 |
| 运行测试 | 执行并验证 | 1-2 分钟 |
| 修复错误 | 单个失败修复 | 3-5 分钟 |
| 更新配置 | 配置文件修改 | 1-2 分钟 |

### 拆分示例

**错误（粒度太粗）**：
```markdown
- [ ] 1. 实现游戏引擎
```

**正确（细粒度）**：
```markdown
- [ ] 1. 游戏引擎 - 类型定义
  - [ ] 1.1 创建 types/game.ts
  - [ ] 1.2 运行类型检查

- [ ] 2. 游戏引擎 - 移动逻辑
  - [ ] 2.1 创建 game/movement.ts
  - [ ] 2.2 编写 movement.test.ts
  - [ ] 2.3 运行单元测试
  - [ ] 2.4 **检查点**
```

---

## 状态持久化

### 状态文件

每个功能维护 `progress.md`：

```
.kiro/specs/{feature-name}/
├── story.md
├── requirements.md
├── design.md
├── tasks.md
└── progress.md    # 进度状态
```

### progress.md 格式

```markdown
# {功能名称} - 执行进度

## 当前状态
- **阶段**：实现阶段
- **任务**：2.3 运行单元测试
- **更新**：2024-01-15 14:30:00

## 已完成
- [x] 1.1 创建 types/game.ts ✅ 13:00
- [x] 1.2 运行类型检查 ✅ 13:05
- [x] 2.1 创建 movement.ts ✅ 13:15
- [x] 2.2 编写测试 ✅ 13:25

## 进行中
- [ ] 2.3 运行单元测试
  - 状态：执行中
  - 开始：14:28

## 待执行
- [ ] 3.1 创建 collision.ts
- [ ] 3.2 编写碰撞测试

## 测试状态
| 文件 | 状态 | 结果 | 时间 |
|-----|------|-----|-----|
| movement.test.ts | 通过 | 4/4 | 13:25 |
| collision.test.ts | 待执行 | - | - |

## 错误记录
### 错误 1（已修复）
- **时间**：13:20
- **任务**：2.2 编写测试
- **错误**：TypeError: Cannot read 'x'
- **原因**：Position 未导出
- **修复**：添加 export

## 上下文
- **文件**：types/game.ts, movement.ts
- **服务**：无
- **配置**：无
```

### 更新时机

| 时机 | 更新内容 |
|-----|---------|
| 任务开始 | 进行中任务状态 |
| 任务完成 | 已完成列表 |
| 测试执行 | 测试状态表 |
| 遇到错误 | 错误记录 |
| 检查点 | 完整更新 |

---

## Session 恢复

### 恢复流程

```
1. 读取 progress.md
2. 输出状态摘要
3. 确定恢复点
4. 加载上下文文件
5. 继续执行
```

### 状态摘要模板

```markdown
## Session 恢复

**功能**：{名称}
**进度**：{n}/{total} ({%}%)

**已完成**：1.1, 1.2, 2.1, 2.2 ✅
**当前**：2.3 运行测试（进行中）
**待执行**：3.1, 3.2, 3.3
**阻塞**：无
**错误**：无

继续执行 2.3...
```

### 恢复点判断

```
1. 检查"进行中任务"
2. 如果状态="执行中"且未完成 → 重新执行
3. 如果已完成 → 下一个任务
4. 如果有阻塞 → 跳过依赖任务
```

---

## 检查点

### 设置规则

每 3-5 个子任务设置检查点：

```markdown
- [ ] 2.1 实现函数
- [ ] 2.2 编写测试
- [ ] 2.3 运行测试
- [ ] 2.4 **检查点**
```

### 检查点内容

1. **更新进度** - progress.md
2. **验证代码** - 编译、lint、测试
3. **确认可恢复** - 上下文完整

---

## 任务模板

### 实现任务

```markdown
- [ ] {n}. 实现 {模块} - {功能}
  - **时间**：5 分钟
  - **文件**：{路径}
  - **函数**：{签名}
  - **验证**：编译通过
```

### 测试任务

```markdown
- [ ] {n}. 测试 {模块} - {场景}
  - **时间**：3 分钟
  - **文件**：{测试路径}
  - **需求**：{需求编号}
  - **验证**：测试通过
```

### 验证任务

```markdown
- [ ] {n}. 验证 {内容}
  - **时间**：2 分钟
  - **命令**：{命令}
  - **预期**：{结果}
```

---

## 任务执行

### 执行流程

```
1. 读取任务 → 2. 更新状态(执行中)
      ↓
3. 执行任务 → 4. 验证结果
      ↓
5. 更新状态(完成/失败)
      ↓
6. 失败? → 记录错误 → 尝试修复(≤2次)
      ↓
7. 下一个任务
```

### 失败处理

```
1. 记录错误到 progress.md
2. 分析原因
3. 尝试修复（最多 2 次）
4. 无法修复：
   - 标记"阻塞"
   - 跳过依赖任务
   - 继续独立任务
```

### 依赖管理

```markdown
- [ ] 1.1 类型定义
- [ ] 1.2 核心函数（依赖：1.1）
- [ ] 1.3 测试（依赖：1.1, 1.2）
```

1.1 失败时：

```markdown
## 阻塞任务
- [ ] 1.2 - 阻塞（依赖 1.1）
- [ ] 1.3 - 阻塞（依赖 1.1, 1.2）
```

---

## 命名规范

### 任务命名

```
{编号}. {动词} {对象} - {内容}

示例：
- 1.1 创建 types/game.ts - Position 接口
- 1.2 实现 movement.ts - calculateNextPosition
- 1.3 编写 movement.test.ts - 方向测试
- 1.4 运行 单元测试 - movement
```

### 动词列表

| 动词 | 用途 |
|-----|-----|
| 创建 | 新建文件 |
| 实现 | 编写代码 |
| 编写 | 写测试 |
| 运行 | 执行命令 |
| 修复 | 修复错误 |
| 更新 | 修改配置 |
| 验证 | 检查结果 |

---

## 错误记录规范

### 必须包含

- 完整错误消息
- 文件和行号
- 相关代码片段
- 尝试的修复方案
- 最终状态（已修复/阻塞）

### 格式

```markdown
### 错误 {n}（{状态}）
- **时间**：{时间}
- **任务**：{任务}
- **错误**：{消息}
- **位置**：{文件}:{行号}
- **原因**：{分析}
- **修复**：{方案}
```

---

## 最佳实践

1. **频繁更新** - 每个子任务都更新状态
2. **完整上下文** - 记录所有相关文件
3. **及时检查点** - 每 3-5 个任务
4. **详细错误** - 包含完整信息
5. **依赖清晰** - 明确标注依赖关系
