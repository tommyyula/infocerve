---
inclusion: manual
---

# 领域建模编写规范（Domain Model Guidelines）

## 概述

本规范定义了领域建模（战术设计）的编写标准。

---

## 文件位置

```
.kiro/specs/{feature-name}/domain-model.md
```

---

## 模板结构

```markdown
# {功能名称} - 领域建模

## 1. 聚合设计
## 2. 实体设计
## 3. 值对象设计
## 4. 领域服务
## 5. 领域事件
## 6. 仓储接口
```

---

## 1. 聚合设计

### 聚合结构描述

聚合根：{聚合根名称}
- 属性列表（属性名、类型、说明）
- 实体列表（实体名、属性）
- 聚合方法（方法名、说明、业务规则）

### 聚合边界规则

- 一个事务一个聚合 - 事务边界不跨聚合
- 通过聚合根访问 - 外部不直接访问聚合内实体
- ID 引用 - 聚合间通过 ID 引用
- 小聚合原则 - 聚合尽量小，避免大聚合

---

## 2. 实体设计

### 实体特征

- 唯一标识 - 有 ID，生命周期内不变
- 可变性 - 属性可以变化
- 生命周期 - 有创建、修改、删除
- 业务行为 - 包含业务方法

### 实体设计内容

- 标识
- 属性（属性名、类型、必填、说明）
- 行为（方法名、参数、返回值、业务规则）
- 状态机（状态流转图）

---

## 3. 值对象设计

### 值对象特征

- 无标识 - 没有 ID
- 不可变 - 创建后不能修改
- 值相等 - 通过属性值判断相等
- 可替换 - 整体替换而非修改

### 值对象设计内容

- 属性（属性名、类型、约束）
- 行为（方法名、说明）
- 不变量

### 常用值对象类型

- 标识类 - ItemId, OrderId（封装 ID，类型安全）
- 数量类 - Quantity, Money（数值 + 单位）
- 编码类 - ItemCode, OrderNo（业务编码）
- 范围类 - DateRange, QuantityRange（区间值）
- 组合类 - Address, Contact（多属性组合）

### 代码示例

```java
// Use Java record for immutability
public record Quantity(BigDecimal value) {
    public Quantity {
        if (value == null || value.compareTo(BigDecimal.ZERO) < 0) {
            throw new IllegalArgumentException("Quantity cannot be null or negative");
        }
    }
    
    public Quantity add(Quantity other) {
        return new Quantity(this.value.add(other.value));
    }
}
```

---

## 4. 领域服务

### 何时使用领域服务

- 跨聚合操作 - 涉及多个聚合的业务逻辑
- 无状态计算 - 不属于任何实体的计算
- 外部依赖 - 需要调用外部服务

### 领域服务设计内容

- 职责
- 方法（方法名、参数、返回值、说明）
- 依赖

---

## 5. 领域事件

### 事件设计内容

- 事件名称
- 触发时机
- 携带数据
- 订阅者

### 事件命名规范

```
{聚合名}{动作过去式}Event

示例：
- InboundOrderCreatedEvent    入库单已创建
- InboundOrderConfirmedEvent  入库单已确认
- InventoryChangedEvent       库存已变动
```

---

## 6. 仓储接口

### 仓储设计内容

- 职责
- 方法（方法名、参数、返回值、说明）

### 仓储设计规则

- 只操作聚合根 - 不直接操作聚合内实体
- 接口在领域层 - 实现在基础设施层
- 返回领域对象 - 不返回 PO 或 DTO
- 封装查询逻辑 - 复杂查询封装在仓储中

---

## 检查清单

聚合设计：
- [ ] 聚合根有唯一标识
- [ ] 聚合边界清晰
- [ ] 聚合间通过 ID 引用
- [ ] 聚合方法包含业务规则

实体设计：
- [ ] 实体有唯一标识
- [ ] 业务方法在实体中
- [ ] 状态变化有状态机描述

值对象设计：
- [ ] 值对象不可变
- [ ] 使用 record 定义
- [ ] 包含必要的校验逻辑

领域服务：
- [ ] 只用于跨聚合逻辑
- [ ] 无状态
- [ ] 命名清晰

领域事件：
- [ ] 事件命名符合规范
- [ ] 携带必要数据
- [ ] 订阅者明确

仓储接口：
- [ ] 只操作聚合根
- [ ] 接口定义在领域层
- [ ] 返回领域对象

---

## 常见问题

Q: 实体和值对象如何区分？
A: 需要跟踪生命周期、有唯一标识的是实体；只关心值、可替换的是值对象。

Q: 聚合应该多大？
A: 尽量小。一个聚合通常包含1个聚合根 + 少量实体/值对象。

Q: 领域服务和应用服务的区别？
A: 领域服务包含业务逻辑，应用服务只做编排。

---

## 下一步

完成 domain-model.md 后，进入前端原型阶段，创建 demo/。

---

最后更新：2026-01-03
