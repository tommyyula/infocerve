---
inclusion: manual
---

# 测试驱动开发工作流程（TDD + DDD Workflow）

## 概述

本规范定义了结合 DDD（领域驱动设计）和 TDD（测试驱动开发）的完整开发流程。

---

## 开发流程图

```
战略设计阶段
  1. Story（用户故事）
  2. Domain Analysis（领域分析）
  3. Requirements（需求规格）
      |
      v
战术设计阶段
  4. Domain Model（领域建模）
  5. Frontend Demo（前端原型）
      |
      v
技术设计阶段
  6. Design（技术设计）
  7. Database Design（数据库设计）
      |
      v
测试设计阶段
  8. E2E Test Cases
  9. Unit Test Cases
  10. API Test Cases
      |
      v
实现阶段
  11. Tasks - 实现 - 测试验证
```

---

## 核心原则

1. 领域优先 - 先理解业务领域，再考虑技术实现
2. 测试先行 - 先定义测试用例，再实现功能
3. 持续验证 - 每完成一个功能立即运行测试
4. 统一语言 - 团队使用一致的业务术语

[重要] 禁止使用 Kiro spec 的 tasks.md 文件
- 任务管理统一使用 task-manager MCP 工具
- 设计共识记录到 requirements.md + design.md
- tasks.md 仅作为任务概览，不直接编辑

---

## AI 角色总览

阶段 1 Story - 业务分析师
阶段 2 Domain Analysis - 领域专家 / DDD 战略设计师
阶段 3 Requirements - 需求工程师
阶段 4 Domain Model - DDD 战术设计师
阶段 5 Frontend Demo - UX 设计师
阶段 6 Design - 解决方案架构师
阶段 7 Database Design - 数据库架构师
阶段 8-10 Test Cases - 质量保证工程师
阶段 11 Tasks - 技术负责人

---

## 阶段门禁机制

### 核心原则

1. 人工确认 - 每个阶段必须由人工明确确认"通过"后才能进入下一阶段
2. 质量优先 - 不允许跳过任何阶段
3. 可追溯 - 每个阶段的确认状态记录在 progress.md 中

### AI 行为规范

阶段开始时：
1. 检查 progress.md，确认上一阶段状态为"已通过"
2. 宣布当前角色

阶段结束时：
1. 完成阶段产出文档
2. 进行自检，输出检查清单
3. 请求人工审核
4. 等待人工确认，不主动进入下一阶段

---

## Spec 文档结构

### 文件命名规范

[重要] 所有 Spec 文档必须使用序号前缀命名，格式为 `{序号}-{文件名}.md`

```
.kiro/specs/{feature-name}/
  01-story.md                 # 1. 用户故事
  02-domain-analysis.md       # 2. 领域分析
  03-requirements.md          # 3. 需求规格
  04-domain-model.md          # 4. 领域建模
  05-demo/                    # 5. 前端原型
    index.html                #    PC端 Demo
    mobile.html               #    手持端 Demo（如有）
  06-design.md                # 6. 技术设计
  07-database-design.md       # 7. 数据库设计
  08-e2e-test-cases.md        # 8. E2E 测试用例
  09-unit-test-cases.md       # 9. 单元测试用例
  10-api-test-cases.md        # 10. API 测试用例
  progress.md                 # 进度状态（无序号）
```

序号规则：
- 序号使用两位数字（01-10）
- 所有阶段产出文件/目录都使用序号前缀（包括 05-demo 目录）
- progress.md 不加序号前缀（进度跟踪文件）
- 任务由 task-manager MCP 工具管理，不创建 tasks.md

### 文档阅读顺序

[重要] 产出文件清单必须按以下顺序标识，方便阅读和 review：

```
推荐阅读顺序：

1. 01-story.md              - 了解业务背景和用户需求
2. 02-domain-analysis.md    - 理解领域概念和业务规则
3. 03-requirements.md       - 查看详细的功能需求和验收标准
4. 04-domain-model.md       - 理解领域模型设计（聚合、实体、值对象）
5. demo/index.html          - 查看前端原型，直观理解交互流程
6. 06-design.md             - 查看技术架构和 API 设计
7. 07-database-design.md    - 查看数据库表结构和映射关系
8. 08-e2e-test-cases.md     - 查看端到端测试用例
9. 09-unit-test-cases.md    - 查看单元测试用例
10. 10-api-test-cases.md    - 查看 API 测试用例
```

AI 在输出产出文件清单时，必须：
1. 按上述顺序列出文件
2. 使用带序号前缀的文件名
3. 简要说明每个文件的核心内容

---

## 文档产出自检清单

[重要] 每个阶段结束时必须对照此清单进行自检，确保文档完整性。

### 阶段 1 自检：01-story.md

必须包含：
- [ ] 背景描述（为什么需要这个功能）
- [ ] 用户故事列表（作为...我想要...以便于...）
- [ ] 每个故事的验收标准（3-8 条）
- [ ] 故事符合 INVEST 原则

### 阶段 2 自检：02-domain-analysis.md

必须包含：
- [ ] 统一语言表（中英文术语对照）
- [ ] 领域分类（核心域/支撑域/通用域）
- [ ] 限界上下文边界
- [ ] 业务流程图
- [ ] 业务规则列表（BR-001, BR-002...）

### 阶段 3 自检：03-requirements.md

必须包含：
- [ ] 功能需求列表
- [ ] EARS 模式验收标准
- [ ] 非功能需求（性能、安全等）
- [ ] 约束条件和边界

### 阶段 4 自检：04-domain-model.md

必须包含：
- [ ] 聚合根定义（边界、不变量）
- [ ] 实体定义（标识、生命周期）
- [ ] 值对象定义（不可变、无标识）
- [ ] 领域服务定义
- [ ] 领域事件定义
- [ ] 仓储接口定义

### 阶段 5 自检：demo/

必须包含：
- [ ] demo/index.html（PC端原型）
- [ ] demo/mobile.html（手持端原型，如有）
- [ ] 核心页面完整
- [ ] 页面切换功能正常
- [ ] 业务流程可演示

### 阶段 6 自检：06-design.md

必须包含：
- [ ] 架构设计（分层结构）
- [ ] API 设计（路径、方法、请求/响应）
- [ ] 错误码设计
- [ ] 安全设计（权限控制）
- [ ] 性能考虑（缓存、批量处理）

### 阶段 7 自检：07-database-design.md

必须包含：
- [ ] 表结构设计（字段、类型、约束）
- [ ] 索引设计
- [ ] Entity-PO 映射关系
- [ ] 数据迁移方案（如有）

### 阶段 8 自检：08-e2e-test-cases.md

必须包含：
- [ ] 核心业务流程测试用例
- [ ] 测试用例关联用户故事
- [ ] 测试步骤清晰可执行
- [ ] 预期结果明确

### 阶段 9 自检：09-unit-test-cases.md

必须包含：
- [ ] 值对象测试用例
- [ ] 聚合根方法测试用例
- [ ] 领域服务测试用例
- [ ] 应用服务测试用例
- [ ] 测试用例关联业务规则

### 阶段 10 自检：10-api-test-cases.md

必须包含：
- [ ] 每个 API 接口的测试用例
- [ ] 正常流程测试
- [ ] 异常流程测试（参数校验、权限等）
- [ ] 边界条件测试

### 阶段 11 自检：实现完成

必须完成：
- [ ] 所有 task-manager 任务状态为已完成
- [ ] 单元测试通过（覆盖率达标）
- [ ] API 测试通过
- [ ] E2E 测试通过
- [ ] progress.md 更新为全部通过

---

## 各阶段详细说明

### 阶段 1：用户故事（Story）

AI 角色：业务分析师

完成检查清单：
- 背景描述清晰
- 每个故事有明确的用户角色
- 每个故事的功能描述具体可操作
- 每个故事有 3-8 条可测试的验收标准
- 故事符合 INVEST 原则

阶段结束时输出：
```
阶段 1 自检结果：
- [x] 背景描述（为什么需要这个功能）
- [x] 用户故事列表（作为...我想要...以便于...）
- [x] 每个故事的验收标准（3-8 条）
- [x] 故事符合 INVEST 原则

产出文件：01-story.md
请确认是否通过？
```

详细规范：#21-STORY-GUIDELINES

### 阶段 2：领域分析（Domain Analysis）

AI 角色：领域专家 / DDD 战略设计师

完成检查清单：
- 统一语言覆盖所有业务术语
- 领域分类合理
- 限界上下文边界清晰
- 业务流程完整
- 业务规则有唯一编号

阶段结束时输出：
```
阶段 2 自检结果：
- [x] 统一语言表（中英文术语对照）
- [x] 领域分类（核心域/支撑域/通用域）
- [x] 限界上下文边界
- [x] 业务流程图
- [x] 业务规则列表（BR-001, BR-002...）

产出文件：02-domain-analysis.md
请确认是否通过？
```

详细规范：#22-DOMAIN-ANALYSIS

### 阶段 3：需求规格（Requirements）

AI 角色：需求工程师

完成检查清单：
- 使用 EARS 模式编写验收标准
- 系统名称使用统一语言
- 每条验收标准可测试
- 覆盖正常流程和异常流程

阶段结束时输出：
```
阶段 3 自检结果：
- [x] 功能需求列表
- [x] EARS 模式验收标准
- [x] 非功能需求（性能、安全等）
- [x] 约束条件和边界

产出文件：03-requirements.md
请确认是否通过？
```

详细规范：#23-REQUIREMENTS-GUIDELINES

### 阶段 4：领域建模（Domain Model）

AI 角色：DDD 战术设计师

完成检查清单：
- 聚合边界合理
- 实体和值对象正确区分
- 值对象不可变
- 领域事件覆盖关键业务节点
- 仓储接口只操作聚合根

阶段结束时输出：
```
阶段 4 自检结果：
- [x] 聚合根定义（边界、不变量）
- [x] 实体定义（标识、生命周期）
- [x] 值对象定义（不可变、无标识）
- [x] 领域服务定义
- [x] 领域事件定义
- [x] 仓储接口定义

产出文件：04-domain-model.md
请确认是否通过？
```

详细规范：#24-DOMAIN-MODEL

### 阶段 5：前端原型 Demo

AI 角色：UX 设计师

完成检查清单：
- PC端 Demo 包含所有核心页面
- 手持端 Demo 包含所有核心页面（如有）
- 业务流程在界面上清晰呈现
- 页面切换功能正常

阶段结束时输出：
```
阶段 5 自检结果：
- [x] demo/index.html（PC端原型）
- [x] demo/mobile.html（手持端原型，如有）
- [x] 核心页面完整
- [x] 页面切换功能正常
- [x] 业务流程可演示

产出文件：demo/index.html, demo/mobile.html
请确认是否通过？
```

详细规范：#25-FRONTEND-DEMO

### 阶段 6：技术设计（Design）

AI 角色：解决方案架构师

完成检查清单：
- 分层架构符合 DDD 规范
- API 设计完整
- 错误码设计完整
- 安全设计考虑权限控制

阶段结束时输出：
```
阶段 6 自检结果：
- [x] 架构设计（分层结构）
- [x] API 设计（路径、方法、请求/响应）
- [x] 错误码设计
- [x] 安全设计（权限控制）
- [x] 性能考虑（缓存、批量处理）

产出文件：06-design.md
请确认是否通过？
```

详细规范：#26-DESIGN-GUIDELINES

### 阶段 7：数据库设计（Database Design）

AI 角色：数据库架构师

完成检查清单：
- 表结构正确映射领域模型
- 命名符合规范
- 索引设计覆盖高频查询
- Entity-PO 映射清晰

阶段结束时输出：
```
阶段 7 自检结果：
- [x] 表结构设计（字段、类型、约束）
- [x] 索引设计
- [x] Entity-PO 映射关系
- [x] 数据迁移方案（如有）

产出文件：07-database-design.md
请确认是否通过？
```

详细规范：#27-DATABASE-DESIGN

### 阶段 8-10：测试用例设计

AI 角色：质量保证工程师

完成检查清单：
- E2E 测试覆盖核心业务流程
- 单元测试覆盖所有值对象和聚合方法
- API 测试覆盖所有接口
- 测试用例关联需求和业务规则

阶段结束时输出：
```
阶段 8-10 自检结果：

E2E 测试用例（阶段 8）：
- [x] 核心业务流程测试用例
- [x] 测试用例关联用户故事
- [x] 测试步骤清晰可执行

单元测试用例（阶段 9）：
- [x] 值对象测试用例
- [x] 聚合根方法测试用例
- [x] 领域服务测试用例
- [x] 应用服务测试用例

API 测试用例（阶段 10）：
- [x] 每个 API 接口的测试用例
- [x] 正常流程测试
- [x] 异常流程测试

产出文件：08-e2e-test-cases.md, 09-unit-test-cases.md, 10-api-test-cases.md
请确认是否通过？
```

详细规范：#30-TEST-CASE-GUIDELINES

### 阶段 11：实现任务（Tasks）

AI 角色：技术负责人

任务由 task-manager MCP 工具管理，按 DDD 分层组织：
1. 领域层实现
2. 应用层实现
3. 基础设施层实现
4. 接口层实现
5. BFF 层实现
6. 前端实现
7. 完成验证

阶段结束时输出：
```
阶段 11 自检结果：
- [x] 所有 task-manager 任务状态为已完成
- [x] 单元测试通过（领域层 >= 90%，应用层 >= 80%）
- [x] API 测试通过
- [x] E2E 测试通过
- [x] progress.md 更新为全部通过

功能开发完成，请进行最终验收。
```

---

## 测试覆盖率要求

领域层单元测试：行覆盖率 >= 90%
应用层单元测试：行覆盖率 >= 80%
API 测试：行覆盖率 >= 90%
E2E 测试：核心流程 100%

---

## 注意事项

1. 领域优先 - 先完成领域分析和建模，再考虑技术实现
2. 统一语言 - 团队必须使用一致的业务术语
3. 聚合边界 - 一个事务只修改一个聚合
4. 测试先行 - 先写测试用例文档，再实现功能
5. 分层实现 - 按 Domain - Application - Infrastructure - Interfaces 顺序实现

---

最后更新：2026-01-03
