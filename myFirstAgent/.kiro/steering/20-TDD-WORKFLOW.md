---
inclusion: manual
---

# 测试驱动开发工作流程（TDD + DDD Workflow）

## 概述

本规范定义了结合 DDD（领域驱动设计）和 TDD（测试驱动开发）的完整开发流程。

---

## 开发流程图

```
战略设计阶段（理解业务）
  1. Story（用户故事）
  2. Domain Analysis（领域分析）
  3. Requirements（需求规格）
      |
      v
战术设计阶段（领域建模）
  4. Domain Model（领域建模）
  5. Frontend Demo（前端原型）
  6. FSD（前端规格文档）
      |
      v
技术设计阶段（技术实现方案）
  7. Design（技术设计）
  8. Repository Design（仓储设计）
      |
      v
测试设计阶段（测试先行）
  9. E2E Test Cases
  10. Unit Test Cases
  11. API Test Cases
      |
      v
实现阶段（编码实现）
  12. Tasks - 实现 - 测试验证
```

---

## 核心原则

1. 领域优先 - 先理解业务领域，再考虑技术实现
2. 测试先行 - 先定义测试用例，再实现功能
3. 持续验证 - 每完成一个功能立即运行测试
4. 统一语言 - 团队使用一致的业务术语

[重要] 禁止使用 Kiro spec 的 tasks.md 文件
- 任务管理统一使用 task-manager MCP 工具
- 设计共识记录到 requirements.md + design.md
- tasks.md 仅作为任务概览，不直接编辑

---

## AI 角色总览

阶段 1 Story - 业务分析师
阶段 2 Domain Analysis - 领域专家 / DDD 战略设计师
阶段 3 Requirements - 需求工程师
阶段 4 Domain Model - DDD 战术设计师
阶段 5 Frontend Demo - UX 设计师
阶段 6 FSD - 产品经理
阶段 7 Design - 解决方案架构师
阶段 8 Repository Design - 仓储设计师 / DDD 基础设施层专家
阶段 9-11 Test Cases - 质量保证工程师
阶段 12 Tasks - 技术负责人

---

## 阶段门禁机制

### 核心原则

1. 人工确认 - 每个阶段必须由人工明确确认"通过"后才能进入下一阶段
2. 质量优先 - 不允许跳过任何阶段
3. 可追溯 - 每个阶段的确认状态记录在 progress.md 中

### AI 行为规范

阶段开始时：
1. 检查 progress.md，确认上一阶段状态为"已通过"
2. 宣布当前角色

阶段结束时：
1. 完成阶段产出文档
2. 进行自检，输出检查清单
3. 请求人工审核
4. 等待人工确认，不主动进入下一阶段

---

## Spec 文档结构

### 文件命名规范

[重要] 所有 Spec 文档必须使用序号前缀命名，格式为 `{序号}-{文件名}.md`

```
.kiro/specs/{feature-name}/
  01-story.md                 # 1. 用户故事
  02-domain-analysis.md       # 2. 领域分析
  03-requirements.md          # 3. 需求规格
  04-domain-model.md          # 4. 领域建模
  05-demo/                    # 5. 前端原型
    index.html                #    PC端 Demo
    mobile.html               #    手持端 Demo（如有）
  06-fsd/                    # 6. FSD 文档（按模块拆分）
    README.md                 #    FSD 索引和总览
    {module-name}.md          #    各模块 FSD
  07-design.md                # 7. 技术设计
  08-repository-design.md     # 8. 仓储设计
  09-e2e-test-cases.md        # 9. E2E 测试用例
  10-unit-test-cases.md       # 10. 单元测试用例
  11-api-test-cases.md        # 11. API 测试用例
  progress.md                 # 进度状态（无序号）
```

序号规则：
- 序号使用两位数字（01-11）
- 所有阶段产出文件/目录都使用序号前缀（包括 05-demo、06-prds 目录）
- progress.md 不加序号前缀（进度跟踪文件）
- 任务由 task-manager MCP 工具管理，不创建 tasks.md

### 文档阅读顺序

[重要] 产出文件清单必须按以下顺序标识，方便阅读和 review：

```
推荐阅读顺序：

1. 01-story.md              - 了解业务背景和用户需求
2. 02-domain-analysis.md    - 理解领域概念和业务规则
3. 03-requirements.md       - 查看详细的功能需求和验收标准
4. 04-domain-model.md       - 理解领域模型设计（聚合、实体、值对象）
5. 05-demo/index.html       - 查看前端原型，直观理解交互流程
6. 06-fsd/README.md        - 查看 FSD 索引，了解模块划分
   06-fsd/{module}.md      - 查看各模块详细 FSD
7. 07-design.md             - 查看技术架构和 API 设计
8. 08-repository-design.md  - 查看仓储层设计（Repository、PO、表结构）
9. 09-e2e-test-cases.md     - 查看端到端测试用例
10. 10-unit-test-cases.md   - 查看单元测试用例
11. 11-api-test-cases.md    - 查看 API 测试用例
```

AI 在输出产出文件清单时，必须：
1. 按上述顺序列出文件
2. 使用带序号前缀的文件名
3. 简要说明每个文件的核心内容

---

## 文档产出自检清单

[重要] 每个阶段结束时必须对照此清单进行自检，确保文档完整性。

### 阶段 1 自检：01-story.md

必须包含：
- [ ] 背景描述（为什么需要这个功能）
- [ ] 用户故事列表（作为...我想要...以便于...）
- [ ] 每个故事的验收标准（3-8 条）
- [ ] 故事符合 INVEST 原则

### 阶段 2 自检：02-domain-analysis.md

必须包含：
- [ ] 统一语言表（中英文术语对照）
- [ ] 领域分类（核心域/支撑域/通用域）
- [ ] 限界上下文边界
- [ ] 业务流程图
- [ ] 业务规则列表（BR-001, BR-002...）

### 阶段 3 自检：03-requirements.md

必须包含：
- [ ] 功能需求列表
- [ ] EARS 模式验收标准
- [ ] 非功能需求（性能、安全等）
- [ ] 约束条件和边界

### 阶段 4 自检：04-domain-model.md

必须包含：
- [ ] 聚合根定义（边界、不变量）
- [ ] 实体定义（标识、生命周期）
- [ ] 值对象定义（不可变、无标识）
- [ ] 领域服务定义
- [ ] 领域事件定义
- [ ] 仓储接口定义

### 阶段 5 自检：05-demo/

必须包含：
- [ ] 05-demo/index.html（PC端原型）
- [ ] 05-demo/mobile.html（手持端原型，如有）
- [ ] 核心页面完整
- [ ] 页面切换功能正常
- [ ] 业务流程可演示

### 阶段 6 自检：06-fsd/

必须包含：
- [ ] 06-fsd/README.md（FSD 索引和总览）
- [ ] 每个模块独立的 FSD 文件
- [ ] 每个 FSD 包含：功能概述、用户场景、界面说明、交互逻辑、数据字段、业务规则、异常处理
- [ ] FSD 与 Demo 页面对应
- [ ] FSD 与 Requirements 需求项对应

### 阶段 7 自检：07-design.md

必须包含：
- [ ] 架构设计（分层结构、模块依赖）
- [ ] 流程图（PlantUML 时序图、活动图、类图）
- [ ] 应用服务设计（职责和方法）
- [ ] Repository 接口详细设计（参数类型、返回值类型）
- [ ] API 设计（路径、方法、请求/响应）
- [ ] 错误码设计
- [ ] 安全设计（权限控制）
- [ ] 性能考虑（缓存、批量处理）

### 阶段 8 自检：08-repository-design.md

必须包含：
- [ ] Repository 实现类设计
- [ ] Entity-PO 映射关系
- [ ] 表结构设计（字段、类型、约束）
- [ ] 索引设计
- [ ] 缓存策略（如有 Redis）
- [ ] 查询优化方案
- [ ] 数据迁移脚本（如有）

### 阶段 9 自检：09-e2e-test-cases.md

必须包含：
- [ ] 核心业务流程测试用例
- [ ] 测试用例关联用户故事
- [ ] 测试步骤清晰可执行
- [ ] 预期结果明确

### 阶段 10 自检：10-unit-test-cases.md

必须包含：
- [ ] 值对象测试用例
- [ ] 聚合根方法测试用例
- [ ] 领域服务测试用例
- [ ] 应用服务测试用例
- [ ] 测试用例关联业务规则

### 阶段 11 自检：11-api-test-cases.md

必须包含：
- [ ] 每个 API 接口的测试用例
- [ ] 正常流程测试
- [ ] 异常流程测试（参数校验、权限等）
- [ ] 边界条件测试

### 阶段 12 自检：实现完成

必须完成：
- [ ] 所有 task-manager 任务状态为已完成
- [ ] 单元测试通过（覆盖率达标）
- [ ] API 测试通过
- [ ] E2E 测试通过
- [ ] progress.md 更新为全部通过

---

## 各阶段详细说明

### 阶段 1：用户故事（Story）

AI 角色：业务分析师

完成检查清单：
- 背景描述清晰
- 每个故事有明确的用户角色
- 每个故事的功能描述具体可操作
- 每个故事有 3-8 条可测试的验收标准
- 故事符合 INVEST 原则

阶段结束时输出：
```
阶段 1 自检结果：
- [x] 背景描述（为什么需要这个功能）
- [x] 用户故事列表（作为...我想要...以便于...）
- [x] 每个故事的验收标准（3-8 条）
- [x] 故事符合 INVEST 原则

产出文件：01-story.md
请确认是否通过？
```

详细规范：#21-STORY-GUIDELINES

### 阶段 2：领域分析（Domain Analysis）

AI 角色：领域专家 / DDD 战略设计师

完成检查清单：
- 统一语言覆盖所有业务术语
- 领域分类合理
- 限界上下文边界清晰
- 业务流程完整
- 业务规则有唯一编号

阶段结束时输出：
```
阶段 2 自检结果：
- [x] 统一语言表（中英文术语对照）
- [x] 领域分类（核心域/支撑域/通用域）
- [x] 限界上下文边界
- [x] 业务流程图
- [x] 业务规则列表（BR-001, BR-002...）

产出文件：02-domain-analysis.md
请确认是否通过？
```

详细规范：#22-DOMAIN-ANALYSIS

### 阶段 3：需求规格（Requirements）

AI 角色：需求工程师

完成检查清单：
- 使用 EARS 模式编写验收标准
- 系统名称使用统一语言
- 每条验收标准可测试
- 覆盖正常流程和异常流程

阶段结束时输出：
```
阶段 3 自检结果：
- [x] 功能需求列表
- [x] EARS 模式验收标准
- [x] 非功能需求（性能、安全等）
- [x] 约束条件和边界

产出文件：03-requirements.md
请确认是否通过？
```

详细规范：
- #23-REQUIREMENTS-GUIDELINES - 需求规格编写规范
- #41-ERROR-CODE-GUIDELINES - 错误码定义规范（定义错误码范围和分类）

### 阶段 4：领域建模（Domain Model）

AI 角色：DDD 战术设计师

完成检查清单：
- 聚合边界合理
- 实体和值对象正确区分
- 值对象不可变
- 领域事件覆盖关键业务节点
- 仓储接口只操作聚合根

阶段结束时输出：
```
阶段 4 自检结果：
- [x] 聚合根定义（边界、不变量）
- [x] 实体定义（标识、生命周期）
- [x] 值对象定义（不可变、无标识）
- [x] 领域服务定义
- [x] 领域事件定义
- [x] 仓储接口定义

产出文件：04-domain-model.md
请确认是否通过？
```

详细规范：#24-DOMAIN-MODEL

### 阶段 5：前端原型 Demo

AI 角色：UX 设计师

完成检查清单：
- PC端 Demo 包含所有核心页面
- 手持端 Demo 包含所有核心页面（如有）
- 业务流程在界面上清晰呈现
- 页面切换功能正常

阶段结束时输出：
```
阶段 5 自检结果：
- [x] 05-demo/index.html（PC端原型）
- [x] 05-demo/mobile.html（手持端原型，如有）
- [x] 核心页面完整
- [x] 页面切换功能正常
- [x] 业务流程可演示

产出文件：05-demo/index.html, 05-demo/mobile.html
请确认是否通过？
```

详细规范：#25-FRONTEND-DEMO

### 阶段 6：FSD 文档（Frontend Specification Document）

AI 角色：产品经理

职责范围：
- 基于 story、requirements、demo 综合输出面向开发的 FSD
- 按功能模块拆分，每个模块独立成文件
- 确保 FSD 与 Demo 页面一一对应
- 确保 FSD 覆盖所有 Requirements 需求项

FSD 文件结构：
```
06-fsd/
  README.md           # FSD 索引和总览
  {module-1}.md       # 模块 1 的 FSD
  {module-2}.md       # 模块 2 的 FSD
  ...
```

每个模块 FSD 必须包含：
1. 功能概述 - 模块的核心功能和目标
2. 用户场景 - 具体的使用场景描述
3. 界面说明 - 对应 Demo 页面的详细说明
4. 交互逻辑 - 用户操作流程和系统响应
5. 数据字段 - 页面涉及的所有字段及其规则
6. 业务规则 - 关联的业务规则（引用 BR-xxx）
7. 异常处理 - 错误场景和提示信息
8. 依赖说明 - 依赖的 API 接口（引用 design.md）

完成检查清单：
- README.md 包含模块索引和总览
- 每个模块有独立的 FSD 文件
- FSD 与 Demo 页面对应
- FSD 覆盖所有 Requirements 需求项
- 数据字段定义完整
- 业务规则引用正确

阶段结束时输出：
```
阶段 6 自检结果：
- [x] 06-fsd/README.md（FSD 索引和总览）
- [x] 每个模块独立的 FSD 文件
- [x] 每个 FSD 包含：功能概述、用户场景、界面说明、交互逻辑、数据字段、业务规则、异常处理
- [x] FSD 与 Demo 页面对应
- [x] FSD 与 Requirements 需求项对应

产出文件：06-fsd/README.md, 06-fsd/{module-1}.md, 06-fsd/{module-2}.md, ...
请确认是否通过？
```

详细规范：#28-FSD-GUIDELINES

### 阶段 7：技术设计（Design）

AI 角色：解决方案架构师

职责范围：
- 架构设计（分层结构、模块依赖、包结构）
- 流程图设计（PlantUML 时序图、活动图、类图等）
- 应用服务设计（ApplicationService 职责和方法）
- Repository 接口详细设计（具体参数类型、返回值类型）
- API 设计（Controller、DTO、请求/响应）
- 错误处理设计（错误码、异常类）
- 安全设计（权限控制、数据权限）
- 性能考虑（缓存策略、批量处理、异步处理）

不包含：
- 领域模型设计（已在阶段 4 完成）
- Repository 实现类设计（留给阶段 7）
- 数据库表结构设计（留给阶段 7）
- Entity-PO 映射设计（留给阶段 7）

完成检查清单：
- 分层架构符合 DDD 规范
- 流程图完整（时序图、活动图、类图）
- 应用服务职责清晰
- Repository 接口参数和返回值类型明确
- API 设计完整（路径、方法、请求/响应）
- 错误码设计完整
- 安全设计考虑权限控制
- 性能考虑合理

阶段结束时输出：
```
阶段 7 自检结果：
- [x] 架构设计（分层结构、模块依赖）
- [x] 流程图（PlantUML 时序图、活动图、类图）
- [x] 应用服务设计
- [x] Repository 接口详细设计
- [x] API 设计（路径、方法、请求/响应）
- [x] 错误码设计
- [x] 安全设计（权限控制）
- [x] 性能考虑（缓存、批量处理）

产出文件：07-design.md
请确认是否通过？
```

详细规范：
- #26-DESIGN-GUIDELINES - 技术设计规范
- #40-API-GUIDELINES - API 接口 URL 规范
- #41-ERROR-CODE-GUIDELINES - 错误码定义规范

### 阶段 8：仓储设计（Repository Design）

AI 角色：仓储设计师 / DDD 基础设施层专家

职责范围：
- 设计 Repository 实现类（RepositoryImpl）
- 设计领域对象到存储对象的映射（Entity -> PO）
- 设计数据库表结构（MySQL）
- 设计缓存策略（Redis）
- 设计查询优化方案
- 设计数据迁移脚本

不包含：
- Repository 接口设计（已在阶段 4 概要定义，阶段 6 详细设计）
- 领域模型设计（已在阶段 4 完成）
- 应用服务设计（已在阶段 6 完成）

完成检查清单：
- Repository 实现类设计完整
- Entity-PO 映射清晰
- 表结构正确映射领域模型
- 命名符合规范
- 索引设计覆盖高频查询
- 缓存策略合理（如有）

阶段结束时输出：
```
阶段 8 自检结果：
- [x] Repository 实现类设计
- [x] Entity-PO 映射关系
- [x] 表结构设计（字段、类型、约束）
- [x] 索引设计
- [x] 缓存策略（如有 Redis）
- [x] 查询优化方案
- [x] 数据迁移脚本（如有）

产出文件：08-repository-design.md
请确认是否通过？
```

详细规范：#27-REPOSITORY-DESIGN

### 阶段 9-11：测试用例设计

AI 角色：质量保证工程师

完成检查清单：
- E2E 测试覆盖核心业务流程
- 单元测试覆盖所有值对象和聚合方法
- API 测试覆盖所有接口
- 测试用例关联需求和业务规则

阶段结束时输出：
```
阶段 9-11 自检结果：

E2E 测试用例（阶段 9）：
- [x] 核心业务流程测试用例
- [x] 测试用例关联用户故事
- [x] 测试步骤清晰可执行

单元测试用例（阶段 10）：
- [x] 值对象测试用例
- [x] 聚合根方法测试用例
- [x] 领域服务测试用例
- [x] 应用服务测试用例

API 测试用例（阶段 11）：
- [x] 每个 API 接口的测试用例
- [x] 正常流程测试
- [x] 异常流程测试

产出文件：09-e2e-test-cases.md, 10-unit-test-cases.md, 11-api-test-cases.md
请确认是否通过？
```

详细规范：#30-TEST-CASE-GUIDELINES

### 阶段 12：实现任务（Tasks）

AI 角色：技术负责人

任务由 task-manager MCP 工具管理，按 DDD 分层组织：
1. 领域层实现
2. 应用层实现
3. 基础设施层实现
4. 接口层实现
5. BFF 层实现
6. 前端实现
7. 完成验证

阶段结束时输出：
```
阶段 12 自检结果：
- [x] 所有 task-manager 任务状态为已完成
- [x] 单元测试通过（领域层 >= 90%，应用层 >= 80%）
- [x] API 测试通过
- [x] E2E 测试通过
- [x] progress.md 更新为全部通过

功能开发完成，请进行最终验收。
```

---

## 测试覆盖率要求

领域层单元测试：行覆盖率 >= 90%
应用层单元测试：行覆盖率 >= 80%
API 测试：行覆盖率 >= 90%
E2E 测试：核心流程 100%

---

## 注意事项

1. 领域优先 - 先完成领域分析和建模，再考虑技术实现
2. 统一语言 - 团队必须使用一致的业务术语
3. 聚合边界 - 一个事务只修改一个聚合
4. 测试先行 - 先写测试用例文档，再实现功能
5. 分层实现 - 按 Domain - Application - Infrastructure - Interfaces 顺序实现

---

最后更新：2026-01-03
